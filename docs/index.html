<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Darius Max">
<title>Unified Messaging with OmniQueue: A Comprehensive Guide to Broker-Agnostic Messaging Systems and Practical Implementations</title>
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
*,
::before,
::after {
    box-sizing: border-box;
}

html {
    font-size: 100%;
    -webkit-text-size-adjust: 100%;
}

body {
    background: #fff;
    color: rgb(0 0 0 / 0.8);
    padding: 0;
    margin: 0;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-size: inherit;
    line-height: 1;
    position: relative;
    cursor: auto;
    tab-size: 4;
    word-wrap: anywhere;
    -moz-osx-font-smoothing: grayscale;
    -webkit-font-smoothing: antialiased;
}

dl,
dt,
dd,
ul,
ol,
li,
h1,
h2,
h3,
h4,
h5,
h6,
pre,
p,
blockquote,
th,
td {
    margin: 0;
    padding: 0;
}

a {
    background: none;
    color: #2156a5;
    text-decoration: underline;
    line-height: inherit;
}

a:active,
a:hover {
    cursor: pointer;
    outline: 0;
}

a:focus {
    outline: thin dotted;
}

a:hover,
a:focus {
    color: #1d4b8f;
}

abbr {
    font-size: 0.9em;
}

abbr[title] {
    cursor: help;
    border-bottom: 1px dotted #dddddf;
    text-decoration: none;
}

b,
strong {
    font-weight: bold;
    line-height: inherit;
}

strong strong {
    font-weight: 400;
}

code,
kbd,
pre {
    font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
    font-size: 1em;
}

code {
    font-weight: 400;
    color: rgb(0 0 0 / 0.9);
}

pre {
    color: rgb(0 0 0 / 0.9);
    line-height: 1.45;
    text-rendering: optimizeSpeed;
    white-space: pre-wrap;
}

dfn {
    font-style: italic;
}

em,
i {
    font-style: italic;
    line-height: inherit;
}

em em {
    font-style: normal;
}

hr {
    border: solid #dddddf;
    border-width: 1px 0 0;
    clear: both;
    height: 0;
    margin: 1.25em 0 1.1875em;
}

mark {
    background: #ff0;
    color: #000;
}

p {
    line-height: 1.6;
    margin-bottom: 1.25rem;
    text-rendering: optimizeLegibility;
}

q {
    quotes: "\201C" "\201D" "\2018" "\2019";
}

small {
    font-size: 60%;
    line-height: inherit;
}

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

img,
object[type^="image/"],
svg {
    display: inline-block;
    height: auto;
    max-width: 100%;
    vertical-align: middle;
}

img {
    border: 0;
    -ms-interpolation-mode: bicubic;
}

object {
    max-width: 100%;
}

svg:not(:root) {
    overflow: hidden;
}

figure {
    margin: 0;
}

audio,
video {
    display: inline-block;
}

audio:not([controls]) {
    display: none;
    height: 0;
}

.left {
    float: left !important;
}

.right {
    float: right !important;
}

.text-left,
div.text-left>* {
    text-align: left !important;
}

.text-right,
div.text-right>* {
    text-align: right !important;
}

.text-center,
div.text-center>* {
    text-align: center !important;
}

.text-justify,
div.text-justify>* {
    text-align: justify !important;
}

.hide {
    display: none;
}

.subheader,
.admonitionblock td.content>.title,
.audioblock>.title,
.exampleblock>.title,
.imageblock>.title,
.listingblock>.title,
.literalblock>.title,
.stemblock>.title,
.openblock>.title,
.paragraph>.title,
.quoteblock>.title,
table.tableblock>.title,
.verseblock>.title,
.videoblock>.title,
.dlist>.title,
.olist>.title,
.ulist>.title,
.qlist>.title,
.hdlist>.title {
    line-height: 1.45;
    color: #7a2518;
    font-weight: 400;
    margin-top: 0;
    margin-bottom: 0.25em;
}

p aside {
    font-size: 0.875em;
    line-height: 1.35;
    font-style: italic;
}

h1,
h2,
h3,
#toctitle,
.sidebarblock>.content>.title,
h4,
h5,
h6 {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-weight: 300;
    font-style: normal;
    color: #ba3925;
    text-rendering: optimizeLegibility;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.2;
    word-spacing: -0.05em;
}

h1 small,
h2 small,
h3 small,
#toctitle small,
.sidebarblock>.content>.title small,
h4 small,
h5 small,
h6 small {
    color: #e99b8f;
    line-height: 0;
}

h1 {
    font-size: 2.125em;
}

h2 {
    font-size: 1.6875em;
}

h3,
#toctitle,
.sidebarblock>.content>.title {
    font-size: 1.375em;
}

h4,
h5 {
    font-size: 1.125em;
}

h6 {
    font-size: 1em;
}

ul,
ol,
dl {
    line-height: 1.6;
    margin-bottom: 1.25em;
    list-style-position: outside;
    font-family: inherit;
}

ul,
ol {
    margin-left: 1.5em;
}

ul li ul,
ul li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
}

ul.circle {
    list-style-type: circle;
}

ul.disc {
    list-style-type: disc;
}

ul.square {
    list-style-type: square;
}

ul.circle ul:not([class]),
ul.disc ul:not([class]),
ul.square ul:not([class]) {
    list-style: inherit;
}

ol li ul,
ol li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
}

dl dt {
    margin-bottom: 0.3125em;
    font-weight: bold;
}

dl dd {
    margin-bottom: 1.25em;
    margin-left: 1.125em;
}

blockquote {
    margin: 0 0 1.25em;
    padding: 0.5625em 1.25em 0 1.1875em;
    border-left: 1px solid #ddd;
}

blockquote,
blockquote p {
    line-height: 1.6;
    color: rgb(0 0 0 / 0.85);
}

@media screen and (min-width: 768px) {
    h1 {
        font-size: 2.75em;
    }

    h2 {
        font-size: 2.3125em;
    }

    h3,
    #toctitle,
    .sidebarblock>.content>.title {
        font-size: 1.6875em;
    }

    h4 {
        font-size: 1.4375em;
    }
}

table {
    background: #fff;
    border: 1px solid #dedede;
    border-collapse: collapse;
    border-spacing: 0;
    margin-bottom: 1.25em;
    word-wrap: normal;
}

table thead,
table tfoot {
    background: #f7f8f7;
}

table thead tr th,
table thead tr td,
table tfoot tr th,
table tfoot tr td {
    padding: 0.5em 0.625em 0.625em;
    font-size: inherit;
    color: rgb(0 0 0 / 0.8);
    text-align: left;
}

table tr th,
table tr td {
    padding: 0.5625em 0.625em;
    font-size: inherit;
    color: rgb(0 0 0 / 0.8);
}

table tr.even,
table tr.alt {
    background: #f8f8f7;
}

table thead tr th,
table tfoot tr th,
table tbody tr td,
table tr td,
table tfoot tr td {
    line-height: 1.6;
}

h1 strong,
h2 strong,
h3 strong,
#toctitle strong,
.sidebarblock>.content>.title strong,
h4 strong,
h5 strong,
h6 strong {
    font-weight: 400;
}

.center {
    margin-left: auto;
    margin-right: auto;
}

.stretch {
    width: 100%;
}

.clearfix::before,
.clearfix::after,
.float-group::before,
.float-group::after {
    content: "";
    display: table;
}

.clearfix::after,
.float-group::after {
    clear: both;
}

:not(pre).nobreak {
    word-wrap: normal;
}

:not(pre).nowrap {
    white-space: nowrap;
}

:not(pre).pre-wrap {
    white-space: pre-wrap;
}

:not(pre):not([class^=L])>code {
    font-size: 0.9375em;
    font-style: normal !important;
    letter-spacing: 0;
    padding: 0.1em 0.5ex;
    word-spacing: -0.15em;
    background: #f7f7f8;
    border-radius: 4px;
    line-height: 1.45;
    text-rendering: optimizeSpeed;
}

pre code,
pre pre {
    color: inherit;
    font-size: inherit;
    line-height: inherit;
}

pre.nowrap,
pre.nowrap pre {
    white-space: pre;
    word-wrap: normal;
}

.keyseq {
    color: rgb(51 51 51 / 0.8);
}

kbd {
    display: inline-block;
    color: rgb(0 0 0 / 0.8);
    font-size: 0.65em;
    line-height: 1.45;
    background: #f7f7f7;
    border: 1px solid #ccc;
    border-radius: 3px;
    box-shadow: 0 1px 0 rgb(0 0 0 / 0.2), 0 0 0 0.1em #fff inset;
    margin: 0 0.15em;
    padding: 0.2em 0.5em;
    vertical-align: middle;
    position: relative;
    top: -0.1em;
    white-space: nowrap;
}

.keyseq kbd:first-child {
    margin-left: 0;
}

.keyseq kbd:last-child {
    margin-right: 0;
}

.menuseq,
.menuref {
    color: #000;
}

.menuseq b:not(.caret),
.menuref {
    font-weight: inherit;
}

.menuseq {
    word-spacing: -0.02em;
}

.menuseq b.caret {
    font-size: 1.25em;
    line-height: 0.8;
}

.menuseq i.caret {
    font-weight: bold;
    text-align: center;
    width: 0.45em;
}

b.button::before,
b.button::after {
    position: relative;
    top: -1px;
    font-weight: 400;
}

b.button::before {
    content: "[";
    padding: 0 3px 0 2px;
}

b.button::after {
    content: "]";
    padding: 0 2px 0 3px;
}

p a>code:hover {
    color: rgb(0 0 0 / 0.9);
}

body>div[id] {
    margin: 0 auto;
    max-width: 62.5em;
    position: relative;
    padding-left: 0.9375em;
    padding-right: 0.9375em;
    width: 100%;
}

body>div[id]::before,
body>div[id]::after,
#content #footnotes::before {
    content: "";
    display: table;
    clear: both;
}

#content {
    margin-top: 1.25em;
    margin-bottom: 0.625em;
}

#content::before {
    content: none;
}

#header>h1:first-child {
    color: rgb(0 0 0 / 0.85);
    margin-top: 2.25rem;
    margin-bottom: 0;
}

#header>h1:first-child+#toc {
    margin-top: 8px;
    border-top: 1px solid #dddddf;
}

#header>h1:only-child {
    border-bottom: 1px solid #dddddf;
    padding-bottom: 8px;
}

#header .details {
    border-bottom: 1px solid #dddddf;
    line-height: 1.45;
    padding-top: 0.25em;
    padding-bottom: 0.25em;
    padding-left: 0.25em;
    color: rgb(0 0 0 / 0.6);
    display: flex;
    flex-flow: row wrap;
}

#header .details span:first-child {
    margin-left: -0.125em;
}

#header .details span.email a {
    color: rgb(0 0 0 / 0.85);
}

#header .details br {
    display: none;
}

#header .details br+span::before {
    content: "\00a0\2013\00a0";
}

#header .details br+span.author::before {
    content: "\00a0\22c5\00a0";
    color: rgb(0 0 0 / 0.85);
}

#header .details br+span#revremark::before {
    content: "\00a0|\00a0";
}

#header #revnumber {
    text-transform: capitalize;
}

#header #revnumber::after {
    content: "\00a0";
}

#content>h1:first-child:not([class]) {
    color: rgb(0 0 0 / 0.85);
    border-bottom: 1px solid #dddddf;
    padding-bottom: 8px;
    margin-top: 0;
    padding-top: 1rem;
    margin-bottom: 1.25rem;
}

#toc {
    border-bottom: 1px solid #e7e7e9;
    padding-bottom: 0.5em;
}

#toc>ul {
    margin-left: 0.125em;
}

#toc ul.sectlevel0>li>a {
    font-style: italic;
}

#toc ul.sectlevel0 ul.sectlevel1 {
    margin: 0.5em 0;
}

#toc ul {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    list-style-type: none;
}

#toc li {
    line-height: 1.3334;
    margin-top: 0.3334em;
}

#toc a {
    text-decoration: none;
}

#toc a:active {
    text-decoration: underline;
}

#toctitle {
    color: #7a2518;
    font-size: 1.2em;
}

@media screen and (min-width: 768px) {
    #toctitle {
        font-size: 1.375em;
    }

    body.toc2 {
        padding-left: 15em;
        padding-right: 0;
    }

    body.toc2 #header>h1:nth-last-child(2) {
        border-bottom: 1px solid #dddddf;
        padding-bottom: 8px;
    }

    #toc.toc2 {
        margin-top: 0 !important;
        background: #f8f8f7;
        position: fixed;
        width: 15em;
        left: 0;
        top: 0;
        border-right: 1px solid #e7e7e9;
        border-top-width: 0 !important;
        border-bottom-width: 0 !important;
        z-index: 1000;
        padding: 1.25em 1em;
        height: 100%;
        overflow: auto;
    }

    #toc.toc2 #toctitle {
        margin-top: 0;
        margin-bottom: 0.8rem;
        font-size: 1.2em;
    }

    #toc.toc2>ul {
        font-size: 0.9em;
        margin-bottom: 0;
    }

    #toc.toc2 ul ul {
        margin-left: 0;
        padding-left: 1em;
    }

    #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
        padding-left: 0;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 15em;
    }

    body.toc2.toc-right #toc.toc2 {
        border-right-width: 0;
        border-left: 1px solid #e7e7e9;
        left: auto;
        right: 0;
    }
}

@media screen and (min-width: 1280px) {
    body.toc2 {
        padding-left: 20em;
        padding-right: 0;
    }

    #toc.toc2 {
        width: 20em;
    }

    #toc.toc2 #toctitle {
        font-size: 1.375em;
    }

    #toc.toc2>ul {
        font-size: 0.95em;
    }

    #toc.toc2 ul ul {
        padding-left: 1.25em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 20em;
    }
}

#content #toc {
    border: 1px solid #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f8f8f7;
    border-radius: 4px;
}

#footer {
    max-width: none;
    background: rgb(0 0 0 / 0.8);
    padding: 1.25em;
}

#footer-text {
    color: rgb(255 255 255 / 0.8);
    line-height: 1.44;
}

.sect1 {
    padding-bottom: 0.625em;
}

@media screen and (min-width: 768px) {
    #content {
        margin-bottom: 1.25em;
    }

    .sect1 {
        padding-bottom: 1.25em;
    }
}

.sect1:last-child {
    padding-bottom: 0;
}

.sect1+.sect1 {
    border-top: 1px solid #e7e7e9;
}

#content h1>a.anchor,
h2>a.anchor,
h3>a.anchor,
#toctitle>a.anchor,
.sidebarblock>.content>.title>a.anchor,
h4>a.anchor,
h5>a.anchor,
h6>a.anchor {
    position: absolute;
    z-index: 1001;
    width: 1.5ex;
    margin-left: -1.5ex;
    display: block;
    text-decoration: none !important;
    visibility: hidden;
    text-align: center;
    font-weight: 400;
}

#content h1>a.anchor::before,
h2>a.anchor::before,
h3>a.anchor::before,
#toctitle>a.anchor::before,
.sidebarblock>.content>.title>a.anchor::before,
h4>a.anchor::before,
h5>a.anchor::before,
h6>a.anchor::before {
    content: "\00A7";
    font-size: 0.85em;
    display: block;
    padding-top: 0.1em;
}

#content h1:hover>a.anchor,
#content h1>a.anchor:hover,
h2:hover>a.anchor,
h2>a.anchor:hover,
h3:hover>a.anchor,
#toctitle:hover>a.anchor,
.sidebarblock>.content>.title:hover>a.anchor,
h3>a.anchor:hover,
#toctitle>a.anchor:hover,
.sidebarblock>.content>.title>a.anchor:hover,
h4:hover>a.anchor,
h4>a.anchor:hover,
h5:hover>a.anchor,
h5>a.anchor:hover,
h6:hover>a.anchor,
h6>a.anchor:hover {
    visibility: visible;
}

#content h1>a.link,
h2>a.link,
h3>a.link,
#toctitle>a.link,
.sidebarblock>.content>.title>a.link,
h4>a.link,
h5>a.link,
h6>a.link {
    color: #ba3925;
    text-decoration: none;
}

#content h1>a.link:hover,
h2>a.link:hover,
h3>a.link:hover,
#toctitle>a.link:hover,
.sidebarblock>.content>.title>a.link:hover,
h4>a.link:hover,
h5>a.link:hover,
h6>a.link:hover {
    color: #a53221;
}

details,
.audioblock,
.imageblock,
.literalblock,
.listingblock,
.stemblock,
.videoblock {
    margin-bottom: 1.25em;
}

details {
    margin-left: 1.25rem;
}

details>summary {
    cursor: pointer;
    display: block;
    position: relative;
    line-height: 1.6;
    margin-bottom: 0.625rem;
    outline: none;
    -webkit-tap-highlight-color: transparent;
}

details>summary::-webkit-details-marker {
    display: none;
}

details>summary::before {
    content: "";
    border: solid transparent;
    border-left-color: currentColor;
    border-width: 0.3em 0 0.3em 0.5em;
    position: absolute;
    top: 0.5em;
    left: -1.25rem;
    transform: translateX(15%);
}

details[open]>summary::before {
    border: solid transparent;
    border-top-color: currentColor;
    border-width: 0.5em 0.3em 0;
    transform: translateY(15%);
}

details>summary::after {
    content: "";
    width: 1.25rem;
    height: 1em;
    position: absolute;
    top: 0.3em;
    left: -1.25rem;
}

.admonitionblock td.content>.title,
.audioblock>.title,
.exampleblock>.title,
.imageblock>.title,
.listingblock>.title,
.literalblock>.title,
.stemblock>.title,
.openblock>.title,
.paragraph>.title,
.quoteblock>.title,
table.tableblock>.title,
.verseblock>.title,
.videoblock>.title,
.dlist>.title,
.olist>.title,
.ulist>.title,
.qlist>.title,
.hdlist>.title {
    text-rendering: optimizeLegibility;
    text-align: left;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-size: 1rem;
    font-style: italic;
}

table.tableblock.fit-content>caption.title {
    white-space: nowrap;
    width: 0;
}

.paragraph.lead>p,
#preamble>.sectionbody>[class=paragraph]:first-of-type p {
    font-size: 1.21875em;
    line-height: 1.6;
    color: rgb(0 0 0 / 0.85);
}

.admonitionblock>table {
    border-collapse: separate;
    border: 0;
    background: none;
    width: 100%;
}

.admonitionblock>table td.icon {
    text-align: center;
    width: 80px;
}

.admonitionblock>table td.icon img {
    max-width: none;
}

.admonitionblock>table td.icon .title {
    font-weight: bold;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    text-transform: uppercase;
}

.admonitionblock>table td.content {
    padding-left: 1.125em;
    padding-right: 1.25em;
    border-left: 1px solid #dddddf;
    color: rgb(0 0 0 / 0.6);
    word-wrap: anywhere;
}

.admonitionblock>table td.content> :last-child> :last-child {
    margin-bottom: 0;
}

.exampleblock>.content {
    border: 1px solid #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #fffef7;
    border-radius: 4px;
    box-shadow: 0 1px 4px #e0e0dc;
}

.sidebarblock {
    border: 1px solid #dbdbd6;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f3f3f2;
    border-radius: 4px;
}

.sidebarblock>.content>.title {
    color: #7a2518;
    margin-top: 0;
    text-align: center;
}

#content #toc> :first-child,
.exampleblock>.content> :first-child,
.sidebarblock>.content> :first-child {
    margin-top: 0;
}

#content #toc> :last-child,
.exampleblock>.content> :last-child,
.exampleblock>.content> :last-child> :last-child,
.exampleblock>.content .olist>ol>li:last-child> :last-child,
.exampleblock>.content .ulist>ul>li:last-child> :last-child,
.exampleblock>.content .qlist>ol>li:last-child> :last-child,
.sidebarblock>.content> :last-child,
.sidebarblock>.content> :last-child> :last-child,
.sidebarblock>.content .olist>ol>li:last-child> :last-child,
.sidebarblock>.content .ulist>ul>li:last-child> :last-child,
.sidebarblock>.content .qlist>ol>li:last-child> :last-child {
    margin-bottom: 0;
}

.literalblock pre,
.listingblock>.content>pre {
    border-radius: 4px;
    overflow-x: auto;
    padding: 1em;
    font-size: 0.8125em;
}

@media screen and (min-width: 768px) {

    .literalblock pre,
    .listingblock>.content>pre {
        font-size: 0.90625em;
    }
}

@media screen and (min-width: 1280px) {

    .literalblock pre,
    .listingblock>.content>pre {
        font-size: 1em;
    }
}

.literalblock pre,
.listingblock>.content>pre:not(.highlight),
.listingblock>.content>pre[class=highlight],
.listingblock>.content>pre[class^="highlight "] {
    background: #f7f7f8;
}

.literalblock.output pre {
    color: #f7f7f8;
    background: rgb(0 0 0 / 0.9);
}

.listingblock>.content {
    position: relative;
}

.listingblock pre>code {
    display: block;
}

.listingblock code[data-lang]::before {
    display: none;
    content: attr(data-lang);
    position: absolute;
    font-size: 0.75em;
    top: 0.425rem;
    right: 0.5rem;
    line-height: 1;
    text-transform: uppercase;
    color: inherit;
    opacity: 0.5;
}

.listingblock:hover code[data-lang]::before {
    display: block;
}

.listingblock.terminal pre .command::before {
    content: attr(data-prompt);
    padding-right: 0.5em;
    color: inherit;
    opacity: 0.5;
}

.listingblock.terminal pre .command:not([data-prompt])::before {
    content: "$";
}

.listingblock pre.highlightjs {
    padding: 0;
}

.listingblock pre.highlightjs>code {
    padding: 1em;
    border-radius: 4px;
}

.listingblock pre.prettyprint {
    border-width: 0;
}

.prettyprint {
    background: #f7f7f8;
}

pre.prettyprint .linenums {
    line-height: 1.45;
    margin-left: 2em;
}

pre.prettyprint li {
    background: none;
    list-style-type: inherit;
    padding-left: 0;
}

pre.prettyprint li code[data-lang]::before {
    opacity: 1;
}

pre.prettyprint li:not(:first-child) code[data-lang]::before {
    display: none;
}

table.linenotable {
    border-collapse: separate;
    border: 0;
    margin-bottom: 0;
    background: none;
}

table.linenotable td[class] {
    color: inherit;
    vertical-align: top;
    padding: 0;
    line-height: inherit;
    white-space: normal;
}

table.linenotable td.code {
    padding-left: 0.75em;
}

table.linenotable td.linenos {
    width: 0.01%;
}

table.linenotable td.linenos,
pre.pygments .linenos,
pre.rouge .linenos {
    border-right: 1px solid;
    opacity: 0.35;
    padding-right: 0.5em;
    user-select: none;
}

pre.pygments span.linenos,
pre.rouge span.linenos {
    display: inline-block;
    margin-right: 0.75em;
}

.quoteblock {
    margin: 0 1em 1.25em 1.5em;
    display: table;
}

.quoteblock:not(.excerpt)>.title {
    margin-left: -1.5em;
    margin-bottom: 0.75em;
}

.quoteblock blockquote,
.quoteblock p {
    color: rgb(0 0 0 / 0.85);
    font-size: 1.15rem;
    line-height: 1.75;
    word-spacing: 0.1em;
    letter-spacing: 0;
    font-style: italic;
    text-align: justify;
}

.quoteblock blockquote {
    margin: 0;
    padding: 0;
    border: 0;
}

.quoteblock blockquote::before {
    content: "\201c";
    float: left;
    font-size: 2.75em;
    font-weight: bold;
    line-height: 0.6em;
    margin-left: -0.6em;
    color: #7a2518;
    text-shadow: 0 1px 2px rgb(0 0 0 / 0.1);
}

.quoteblock blockquote>.paragraph:last-child p {
    margin-bottom: 0;
}

.quoteblock .attribution {
    margin-top: 0.75em;
    margin-right: 0.5ex;
    text-align: right;
}

.verseblock {
    margin: 0 1em 1.25em;
}

.verseblock pre {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-size: 1.15rem;
    color: rgb(0 0 0 / 0.85);
    font-weight: 300;
    text-rendering: optimizeLegibility;
}

.verseblock pre strong {
    font-weight: 400;
}

.verseblock .attribution {
    margin-top: 1.25rem;
    margin-left: 0.5ex;
}

.quoteblock .attribution,
.verseblock .attribution {
    font-size: 0.9375em;
    line-height: 1.45;
    font-style: italic;
}

.quoteblock .attribution br,
.verseblock .attribution br {
    display: none;
}

.quoteblock .attribution cite,
.verseblock .attribution cite {
    display: block;
    letter-spacing: -0.025em;
    color: rgb(0 0 0 / 0.6);
}

.quoteblock.abstract blockquote::before,
.quoteblock.excerpt blockquote::before,
.quoteblock .quoteblock blockquote::before {
    display: none;
}

.quoteblock.abstract blockquote,
.quoteblock.abstract p,
.quoteblock.excerpt blockquote,
.quoteblock.excerpt p,
.quoteblock .quoteblock blockquote,
.quoteblock .quoteblock p {
    line-height: 1.6;
    word-spacing: 0;
}

.quoteblock.abstract {
    margin: 0 1em 1.25em;
    display: block;
}

.quoteblock.abstract>.title {
    margin: 0 0 0.375em;
    font-size: 1.15em;
    text-align: center;
}

.quoteblock.excerpt>blockquote,
.quoteblock .quoteblock {
    padding: 0 0 0.25em 1em;
    border-left: 0.25em solid #dddddf;
}

.quoteblock.excerpt,
.quoteblock .quoteblock {
    margin-left: 0;
}

.quoteblock.excerpt blockquote,
.quoteblock.excerpt p,
.quoteblock .quoteblock blockquote,
.quoteblock .quoteblock p {
    color: inherit;
    font-size: 1.0625rem;
}

.quoteblock.excerpt .attribution,
.quoteblock .quoteblock .attribution {
    color: inherit;
    font-size: 0.85rem;
    text-align: left;
    margin-right: 0;
}

p.tableblock:last-child {
    margin-bottom: 0;
}

td.tableblock>.content {
    margin-bottom: 1.25em;
    word-wrap: anywhere;
}

td.tableblock>.content> :last-child {
    margin-bottom: -1.25em;
}

table.tableblock,
th.tableblock,
td.tableblock {
    border: 0 solid #dedede;
}

table.grid-all>*>tr>* {
    border-width: 1px;
}

table.grid-cols>*>tr>* {
    border-width: 0 1px;
}

table.grid-rows>*>tr>* {
    border-width: 1px 0;
}

table.frame-all {
    border-width: 1px;
}

table.frame-ends {
    border-width: 1px 0;
}

table.frame-sides {
    border-width: 0 1px;
}

table.frame-none>colgroup+*> :first-child>*,
table.frame-sides>colgroup+*> :first-child>* {
    border-top-width: 0;
}

table.frame-none> :last-child> :last-child>*,
table.frame-sides> :last-child> :last-child>* {
    border-bottom-width: 0;
}

table.frame-none>*>tr> :first-child,
table.frame-ends>*>tr> :first-child {
    border-left-width: 0;
}

table.frame-none>*>tr> :last-child,
table.frame-ends>*>tr> :last-child {
    border-right-width: 0;
}

table.stripes-all>*>tr,
table.stripes-odd>*>tr:nth-of-type(odd),
table.stripes-even>*>tr:nth-of-type(even),
table.stripes-hover>*>tr:hover {
    background: #f8f8f7;
}

th.halign-left,
td.halign-left {
    text-align: left;
}

th.halign-right,
td.halign-right {
    text-align: right;
}

th.halign-center,
td.halign-center {
    text-align: center;
}

th.valign-top,
td.valign-top {
    vertical-align: top;
}

th.valign-bottom,
td.valign-bottom {
    vertical-align: bottom;
}

th.valign-middle,
td.valign-middle {
    vertical-align: middle;
}

table thead th,
table tfoot th {
    font-weight: bold;
}

tbody tr th {
    background: #f7f8f7;
}

tbody tr th,
tbody tr th p,
tfoot tr th,
tfoot tr th p {
    color: rgb(0 0 0 / 0.8);
    font-weight: bold;
}

p.tableblock>code:only-child {
    background: none;
    padding: 0;
}

p.tableblock {
    font-size: 1em;
}

ol {
    margin-left: 1.75em;
}

ul li ol {
    margin-left: 1.5em;
}

dl dd:last-child,
dl dd:last-child> :last-child {
    margin-bottom: 0;
}

li p,
ul dd,
ol dd,
.olist .olist,
.ulist .ulist,
.ulist .olist,
.olist .ulist {
    margin-bottom: 0.625em;
}

ul.checklist,
ul.none,
ol.none,
ul.no-bullet,
ol.no-bullet,
ol.unnumbered,
ul.unstyled,
ol.unstyled {
    list-style-type: none;
}

ul.no-bullet,
ol.no-bullet,
ol.unnumbered {
    margin-left: 0.625em;
}

ul.unstyled,
ol.unstyled {
    margin-left: 0;
}

li>p:empty:only-child::before {
    content: "";
    display: inline-block;
}

ul.checklist>li>p:first-child {
    margin-left: -1em;
}

ul.checklist>li>p:first-child>.fa-square-o:first-child,
ul.checklist>li>p:first-child>.fa-check-square-o:first-child {
    width: 1.25em;
    font-size: 0.8em;
    position: relative;
    bottom: 0.125em;
}

ul.checklist>li>p:first-child>input[type=checkbox]:first-child {
    font: inherit;
    margin: 0 0.25em 0 0;
    padding: 0;
}

ul.inline {
    display: flex;
    flex-flow: row wrap;
    list-style: none;
    margin: 0 0 0.625em -1.25em;
}

ul.inline>li {
    margin-left: 1.25em;
}

.unstyled dl dt {
    font-weight: 400;
    font-style: normal;
}

ol.arabic {
    list-style-type: decimal;
}

ol.decimal {
    list-style-type: decimal-leading-zero;
}

ol.loweralpha {
    list-style-type: lower-alpha;
}

ol.upperalpha {
    list-style-type: upper-alpha;
}

ol.lowerroman {
    list-style-type: lower-roman;
}

ol.upperroman {
    list-style-type: upper-roman;
}

ol.lowergreek {
    list-style-type: lower-greek;
}

.hdlist>table,
.colist>table {
    border: 0;
    background: none;
}

.hdlist>table>tbody>tr,
.colist>table>tbody>tr {
    background: none;
}

td.hdlist1,
td.hdlist2 {
    vertical-align: top;
    padding: 0 0.625em;
}

td.hdlist1 {
    font-weight: bold;
    padding-bottom: 1.25em;
}

td.hdlist2 {
    word-wrap: anywhere;
}

.literalblock+.colist,
.listingblock+.colist {
    margin-top: -0.5em;
}

.colist td:not([class]):first-child {
    padding: 0.4em 0.75em 0;
    line-height: 1;
    vertical-align: top;
}

.colist td:not([class]):first-child img {
    max-width: none;
}

.colist td:not([class]):last-child {
    padding: 0.25em 0;
}

.thumb,
.th {
    line-height: 0;
    display: inline-block;
    border: 4px solid #fff;
    box-shadow: 0 0 0 1px #ddd;
}

.imageblock.left {
    margin: 0.25em 0.625em 1.25em 0;
}

.imageblock.right {
    margin: 0.25em 0 1.25em 0.625em;
}

.imageblock>.title {
    margin-bottom: 0;
}

.imageblock.thumb,
.imageblock.th {
    border-width: 6px;
}

.imageblock.thumb>.title,
.imageblock.th>.title {
    padding: 0 0.125em;
}

.image.left,
.image.right {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
    display: inline-block;
    line-height: 0;
}

.image.left {
    margin-right: 0.625em;
}

.image.right {
    margin-left: 0.625em;
}

a.image {
    text-decoration: none;
    display: inline-block;
}

a.image object {
    pointer-events: none;
}

sup.footnote,
sup.footnoteref {
    font-size: 0.875em;
    position: static;
    vertical-align: super;
}

sup.footnote a,
sup.footnoteref a {
    text-decoration: none;
}

sup.footnote a:active,
sup.footnoteref a:active,
#footnotes .footnote a:first-of-type:active {
    text-decoration: underline;
}

#footnotes {
    padding-top: 0.75em;
    padding-bottom: 0.75em;
    margin-bottom: 0.625em;
}

#footnotes hr {
    width: 20%;
    min-width: 6.25em;
    margin: -0.25em 0 0.75em;
    border-width: 1px 0 0;
}

#footnotes .footnote {
    padding: 0 0.375em 0 0.225em;
    line-height: 1.3334;
    font-size: 0.875em;
    margin-left: 1.2em;
    margin-bottom: 0.2em;
}

#footnotes .footnote a:first-of-type {
    font-weight: bold;
    text-decoration: none;
    margin-left: -1.05em;
}

#footnotes .footnote:last-of-type {
    margin-bottom: 0;
}

#content #footnotes {
    margin-top: -0.625em;
    margin-bottom: 0;
    padding: 0.75em 0;
}

div.page-break {
    display: none;
}

div.unbreakable {
    break-inside: avoid;
}

.big {
    font-size: larger;
}

.small {
    font-size: smaller;
}

.underline {
    text-decoration: underline;
}

.overline {
    text-decoration: overline;
}

.line-through {
    text-decoration: line-through;
}

.aqua {
    color: #00bfbf;
}

.aqua-background {
    background: #00fafa;
}

.black {
    color: #000;
}

.black-background {
    background: #000;
}

.blue {
    color: #0000bf;
}

.blue-background {
    background: #0000fa;
}

.fuchsia {
    color: #bf00bf;
}

.fuchsia-background {
    background: #fa00fa;
}

.gray {
    color: #606060;
}

.gray-background {
    background: #7d7d7d;
}

.green {
    color: #006000;
}

.green-background {
    background: #007d00;
}

.lime {
    color: #00bf00;
}

.lime-background {
    background: #00fa00;
}

.maroon {
    color: #600000;
}

.maroon-background {
    background: #7d0000;
}

.navy {
    color: #000060;
}

.navy-background {
    background: #00007d;
}

.olive {
    color: #606000;
}

.olive-background {
    background: #7d7d00;
}

.purple {
    color: #600060;
}

.purple-background {
    background: #7d007d;
}

.red {
    color: #bf0000;
}

.red-background {
    background: #fa0000;
}

.silver {
    color: #909090;
}

.silver-background {
    background: #bcbcbc;
}

.teal {
    color: #006060;
}

.teal-background {
    background: #007d7d;
}

.white {
    color: #bfbfbf;
}

.white-background {
    background: #fafafa;
}

.yellow {
    color: #bfbf00;
}

.yellow-background {
    background: #fafa00;
}

span.icon>.fa {
    cursor: default;
}

a span.icon>.fa {
    cursor: inherit;
}

.admonitionblock td.icon [class^="fa icon-"] {
    font-size: 2.5em;
    text-shadow: 1px 1px 2px rgb(0 0 0 / 0.5);
    cursor: default;
}

.admonitionblock td.icon .icon-note::before {
    content: "\f05a";
    color: #19407c;
}

.admonitionblock td.icon .icon-tip::before {
    content: "\f0eb";
    text-shadow: 1px 1px 2px rgb(155 155 0 / 0.8);
    color: #111;
}

.admonitionblock td.icon .icon-warning::before {
    content: "\f071";
    color: #bf6900;
}

.admonitionblock td.icon .icon-caution::before {
    content: "\f06d";
    color: #bf3400;
}

.admonitionblock td.icon .icon-important::before {
    content: "\f06a";
    color: #bf0000;
}

.conum[data-value] {
    display: inline-block;
    color: #fff !important;
    background: rgb(0 0 0 / 0.8);
    border-radius: 50%;
    text-align: center;
    font-size: 0.75em;
    width: 1.67em;
    height: 1.67em;
    line-height: 1.67em;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-style: normal;
    font-weight: bold;
}

.conum[data-value] * {
    color: #fff !important;
}

.conum[data-value]+b {
    display: none;
}

.conum[data-value]::after {
    content: attr(data-value);
}

pre .conum[data-value] {
    position: relative;
    top: -0.125em;
}

b.conum * {
    color: inherit !important;
}

.conum:not([data-value]):empty {
    display: none;
}

dt,
th.tableblock,
td.content,
div.footnote {
    text-rendering: optimizeLegibility;
}

h1,
h2,
p,
td.content,
span.alt,
summary {
    letter-spacing: -0.01em;
}

p strong,
td.content strong,
div.footnote strong {
    letter-spacing: -0.005em;
}

p,
blockquote,
dt,
td.content,
td.hdlist1,
span.alt,
summary {
    font-size: 1.0625rem;
}

.sidebarblock p,
.sidebarblock dt,
.sidebarblock td.content,
p.tableblock {
    font-size: 1em;
}

.print-only {
    display: none !important;
}

@page {
    margin: 1.25cm 0.75cm;
}

@media print {
    * {
        box-shadow: none !important;
        text-shadow: none !important;
    }

    html {
        font-size: 80%;
    }

    a {
        color: inherit !important;
        text-decoration: underline !important;
    }

    a.bare,
    a[href^="#"],
    a[href^="mailto:"] {
        text-decoration: none !important;
    }

    a[href^="http:"]:not(.bare)::after,
    a[href^="https:"]:not(.bare)::after {
        content: "(" attr(href) ")";
        display: inline-block;
        font-size: 0.875em;
        padding-left: 0.25em;
    }

    abbr[title] {
        border-bottom: 1px dotted;
    }

    abbr[title]::after {
        content: " (" attr(title) ")";
    }

    pre,
    blockquote,
    tr,
    img,
    object,
    svg {
        break-inside: avoid;
    }

    thead {
        display: table-header-group;
    }

    p,
    blockquote,
    dt,
    td.content {
        font-size: 1em;
        orphans: 3;
        widows: 3;
    }

    h2,
    h3,
    #toctitle,
    .sidebarblock>.content>.title {
        break-after: avoid;
    }

    body>div[id] {
        max-width: none;
    }

    #toc,
    .sidebarblock,
    .exampleblock>.content {
        background: none !important;
    }

    #toc {
        border-bottom: 1px solid #dddddf !important;
        padding-bottom: 0 !important;
    }

    body.book #header {
        text-align: center;
    }

    body.book #header>h1:first-child {
        border: 0 !important;
        margin: 2.5em 0 1em;
    }

    body.book #header .details {
        border: 0 !important;
        display: block;
        padding: 0 !important;
    }

    body.book #header .details span:first-child {
        margin-left: 0 !important;
    }

    body.book #header .details br {
        display: block;
    }

    body.book #header .details br+span::before {
        content: none !important;
    }

    body.book #toc {
        border: 0 !important;
        text-align: left !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    body.book #toc,
    body.book #preamble,
    body.book h1.sect0,
    body.book .sect1>h2 {
        break-before: page;
    }

    .listingblock code[data-lang]::before {
        display: block;
    }

    div.page-break {
        display: block;
        break-after: page;
    }

    #footer {
        padding: 0 0.9375em;
    }

    .hide-on-print {
        display: none !important;
    }

    .print-only {
        display: block !important;
    }

    .hide-for-print {
        display: none !important;
    }

    .show-for-print {
        display: inherit !important;
    }
}

@media amzn-kf8,
print {
    #header>h1:first-child {
        margin-top: 1.25rem;
    }

    .sect1 {
        padding: 0 !important;
    }

    .sect1+.sect1 {
        border: 0;
    }

    #footer {
        background: none;
    }

    #footer-text {
        color: rgb(0 0 0 / 0.6);
        font-size: 0.9em;
    }
}

@media amzn-kf8 {
    body>div[id] {
        padding: 0;
    }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Unified Messaging with OmniQueue: A Comprehensive Guide to Broker-Agnostic Messaging Systems and Practical Implementations</h1>
<div class="details">
<span id="author" class="author">Darius Max</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#_why_this_book_exists">Why This Book Exists</a></li>
<li><a href="#_who_this_book_is_for">Who This Book Is For</a></li>
<li><a href="#_what_this_book_covers">What This Book Covers</a></li>
<li><a href="#_why_omniqueue">Why OmniQueue?</a></li>
<li><a href="#_a_note_on_style">A Note on Style</a></li>
<li><a href="#_reader_expectations">Reader Expectations</a></li>
<li><a href="#_how_this_book_is_organized">How This Book Is Organized</a></li>
<li><a href="#_our_promise">Our Promise</a></li>
</ul>
</li>
<li><a href="#_how_to_use_this_book">How to Use This Book</a>
<ul class="sectlevel2">
<li><a href="#_reading_paths_by_experience_tier">Reading Paths by Experience Tier</a></li>
<li><a href="#_part_by_part_guide">Part-by-Part Guide</a></li>
<li><a href="#_code_examples">Code Examples</a></li>
<li><a href="#_diagrams_and_visuals">Diagrams and Visuals</a></li>
<li><a href="#_cheat_sheets_and_war_stories">Cheat Sheets and War Stories</a></li>
<li><a href="#_cross_references">Cross-References</a></li>
<li><a href="#_what_youll_need">What You’ll Need</a></li>
<li><a href="#_our_advice">Our Advice</a></li>
</ul>
</li>
<li><a href="#_chapter_1_introduction">1. Chapter 1: Introduction</a>
<ul class="sectlevel2">
<li><a href="#_the_role_of_messaging_in_modern_systems">1.1. The Role of Messaging in Modern Systems</a></li>
<li><a href="#_brokered_vs_brokerless_messaging">1.2. Brokered vs. Brokerless Messaging</a></li>
<li><a href="#_the_fragmentation_problem">1.3. The Fragmentation Problem</a></li>
<li><a href="#_enter_omniqueue">1.4. Enter OmniQueue</a></li>
<li><a href="#_a_simple_example">1.5. A Simple Example</a></li>
<li><a href="#_who_uses_omniqueue">1.6. Who Uses OmniQueue?</a></li>
<li><a href="#_what_this_chapter_sets_up">1.7. What This Chapter Sets Up</a></li>
</ul>
</li>
<li><a href="#_core_messaging_concepts">2. Core Messaging Concepts</a>
<ul class="sectlevel2">
<li><a href="#_messages_queues_topics_streams">2.1. Messages, Queues, Topics, Streams</a>
<ul class="sectlevel3">
<li><a href="#_the_message_structure">2.1.1. The Message Structure</a></li>
<li><a href="#_queues">2.1.2. Queues</a></li>
<li><a href="#_topics">2.1.3. Topics</a></li>
<li><a href="#_streams">2.1.4. Streams</a></li>
<li><a href="#_comparing_destinations">2.1.5. Comparing Destinations</a></li>
</ul>
</li>
<li><a href="#_brokers_vs_brokerless">2.2. Brokers vs. Brokerless</a>
<ul class="sectlevel3">
<li><a href="#_what_is_a_broker">2.2.1. What is a Broker?</a></li>
<li><a href="#_brokerless_messaging">2.2.2. Brokerless Messaging</a></li>
<li><a href="#_visual_comparison">2.2.3. Visual Comparison</a></li>
</ul>
</li>
<li><a href="#_delivery_semantics">2.3. Delivery Semantics</a>
<ul class="sectlevel3">
<li><a href="#_at_most_once">2.3.1. At-most-once</a></li>
<li><a href="#_at_least_once">2.3.2. At-least-once</a></li>
<li><a href="#_exactly_once">2.3.3. Exactly-once</a></li>
<li><a href="#_omniqueue_perspective">2.3.4. OmniQueue Perspective</a></li>
</ul>
</li>
<li><a href="#_reliability_durability">2.4. Reliability &amp; Durability</a>
<ul class="sectlevel3">
<li><a href="#_reliability">2.4.1. Reliability</a></li>
<li><a href="#_durability">2.4.2. Durability</a></li>
<li><a href="#_durability_in_omniqueue_context">2.4.3. Durability in OmniQueue Context</a></li>
</ul>
</li>
<li><a href="#_load_balancing_consumer_groups">2.5. Load Balancing &amp; Consumer Groups</a>
<ul class="sectlevel3">
<li><a href="#_consumer_groups">2.5.1. Consumer Groups</a></li>
<li><a href="#_consumer_group_dynamics">2.5.2. Consumer Group Dynamics</a></li>
<li><a href="#_load_balancing_patterns">2.5.3. Load Balancing Patterns</a></li>
</ul>
</li>
<li><a href="#_pubsub_fanout_vs_point_to_point">2.6. Pub/Sub (Fanout) vs. Point-to-Point</a>
<ul class="sectlevel3">
<li><a href="#_point_to_point_p2p">2.6.1. Point-to-Point (P2P)</a></li>
<li><a href="#_publishsubscribe_fanout">2.6.2. Publish/Subscribe (Fanout)</a></li>
<li><a href="#_omniqueues_approach">2.6.3. OmniQueue’s Approach</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_omniqueue_architecture_core_api">3. OmniQueue Architecture &amp; Core API</a>
<ul class="sectlevel2">
<li><a href="#_overview_design_principles">3.1. Overview &amp; Design Principles</a></li>
<li><a href="#_core_api_publish_and_subscribe">3.2. Core API: publish and subscribe</a>
<ul class="sectlevel3">
<li><a href="#_publish">3.2.1. publish()</a></li>
<li><a href="#_subscribe">3.2.2. subscribe()</a></li>
</ul>
</li>
<li><a href="#_message_structure_brokermessage">3.3. Message Structure: <code>BrokerMessage</code></a>
<ul class="sectlevel3">
<li><a href="#_best_practices">3.3.1. Best Practices</a></li>
</ul>
</li>
<li><a href="#_groups_and_work_sharing_semantics">3.4. Groups and Work-sharing Semantics</a>
<ul class="sectlevel3">
<li><a href="#_why_groupid_is_mandatory">3.4.1. Why <code>groupId</code> is mandatory</a></li>
<li><a href="#_work_sharing_model">3.4.2. Work-sharing model</a></li>
<li><a href="#_patterns_enabled_by_groupid">3.4.3. Patterns enabled by <code>groupId</code></a></li>
<li><a href="#_operational_considerations">3.4.4. Operational considerations</a></li>
</ul>
</li>
<li><a href="#_lifecycle_management_init_close">3.5. Lifecycle Management (<code>init</code>, <code>close</code>)</a>
<ul class="sectlevel3">
<li><a href="#_initialization_init">3.5.1. Initialization (<code>init()</code>)</a></li>
<li><a href="#_graceful_shutdown_close">3.5.2. Graceful shutdown (<code>close()</code>)</a></li>
<li><a href="#_common_pitfalls">3.5.3. Common pitfalls</a></li>
</ul>
</li>
<li><a href="#_error_handling_ack_nack">3.6. Error Handling (<code>ack</code>, <code>nack</code>)</a>
<ul class="sectlevel3">
<li><a href="#_acknowledgement_ack">3.6.1. Acknowledgement (<code>ack()</code>)</a></li>
<li><a href="#_negative_acknowledgement_nackrequeue_boolean">3.6.2. Negative acknowledgement (<code>nack(requeue?: boolean)</code>)</a></li>
<li><a href="#_idempotency_for_at_least_once_delivery">3.6.3. Idempotency for at-least-once delivery</a></li>
<li><a href="#_retry_dlq_patterns">3.6.4. Retry &amp; DLQ patterns</a></li>
<li><a href="#_omniqueue_adapter_mapping">3.6.5. OmniQueue adapter mapping</a></li>
</ul>
</li>
<li><a href="#_omniqueue_core_flow_diagram">3.7. OmniQueue Core Flow Diagram</a>
<ul class="sectlevel3">
<li><a href="#_how_to_read_this_diagram">3.7.1. How to Read This Diagram</a></li>
<li><a href="#_flow_breakdown">3.7.2. Flow Breakdown</a></li>
<li><a href="#_operational_notes">3.7.3. Operational Notes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_why_this_book_exists">Why This Book Exists</h3>
<div class="paragraph">
<p>In the last decade, messaging systems have become the invisible backbone of modern software.
From high-frequency trading platforms to e-commerce checkout flows, from IoT telemetry ingestion to social media fanout, <strong>asynchronous message passing</strong> underpins much of the world’s critical software.</p>
</div>
<div class="paragraph">
<p>But there’s a catch: the messaging landscape is <strong>fragmented</strong>.
Each broker — RabbitMQ, Kafka, NATS, ActiveMQ, SQS, and so on — comes with its own API, terminology, quirks, and operational mindset. Switching from one broker to another can mean a complete rewrite of integration code, along with a steep re-learning curve for operations.</p>
</div>
<div class="paragraph">
<p><strong>OmniQueue</strong> was born from a simple but ambitious idea:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>“What if there was a single, unified API that could speak to any messaging system — brokered or brokerless — without sacrificing the power and unique features of each?”</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Founder’s Notes
</div>
</div>
<div class="paragraph">
<p>This book is the culmination of that idea.</p>
</div>
<div class="paragraph">
<p>It’s <strong>both</strong> a deep dive into the theory and practice of messaging systems <strong>and</strong> the definitive guide to OmniQueue — a TypeScript-based, broker-agnostic messaging API.</p>
</div>
</div>
<div class="sect2">
<h3 id="_who_this_book_is_for">Who This Book Is For</h3>
<div class="paragraph">
<p>This book is written for engineers, architects, and operations teams who:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Work with messaging systems regularly.</p>
</li>
<li>
<p>Need to support multiple brokers across environments.</p>
</li>
<li>
<p>Migrate between brokers due to scaling, cost, or vendor lock-in.</p>
</li>
<li>
<p>Want to abstract messaging complexity without losing control.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We’ve structured the content so that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Beginners (0–2 years)</strong> gain a solid grounding in messaging fundamentals.</p>
</li>
<li>
<p><strong>Intermediate practitioners (2–5 years)</strong> learn deep operational patterns and broker-specific optimizations.</p>
</li>
<li>
<p><strong>Senior engineers (5+ years)</strong> explore high-scale, mission-critical messaging architecture and troubleshooting.</p>
</li>
<li>
<p><strong>OmniQueue Mastery Mode</strong> sections give you direct, in-depth knowledge to extend, tune, and contribute to the OmniQueue project.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_what_this_book_covers">What This Book Covers</h3>
<div class="paragraph">
<p>We will explore:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Core messaging concepts: queues, topics, routing, delivery semantics, and reliability.</p>
</li>
<li>
<p>Detailed broker chapters for RabbitMQ, Kafka, NATS JetStream, ActiveMQ Artemis, ZeroMQ, BullMQ, AWS SQS/SNS, Azure Service Bus, and Apache Pulsar.</p>
</li>
<li>
<p>OmniQueue’s architecture, design decisions, and implementation patterns.</p>
</li>
<li>
<p>Mapping native broker concepts to OmniQueue’s unified API.</p>
</li>
<li>
<p>Advanced OmniQueue usage: scaling, plugin development, observability, and disaster recovery.</p>
</li>
<li>
<p>Real-world case studies, complete with war stories from production incidents.</p>
</li>
<li>
<p>How to extend and contribute to OmniQueue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Throughout the book, we’ll balance <strong>conceptual clarity</strong> with <strong>practical hands-on examples</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_omniqueue">Why OmniQueue?</h3>
<div class="paragraph">
<p>Traditional messaging integrations often fall into one of two traps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Tight coupling to a specific broker.</strong>
This limits future flexibility, creates vendor lock-in, and complicates migrations.</p>
</li>
<li>
<p><strong>Overly generic abstractions.</strong>
These hide broker-specific features, leading to lowest-common-denominator APIs.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>OmniQueue aims to solve both problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unified Core API</strong> for sending, receiving, publishing, and subscribing.</p>
</li>
<li>
<p><strong>Broker Adapters</strong> that map directly to native features.</p>
</li>
<li>
<p><strong>Optional Features</strong> for advanced tuning, scaling, and recovery.</p>
</li>
<li>
<p><strong>Plugin Architecture</strong> for extending to new brokers or integrating custom logic.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_a_note_on_style">A Note on Style</h3>
<div class="paragraph">
<p>This book is written in the spirit of O’Reilly guides:
technical, clear, and actionable — with just enough narrative to keep you awake during the heavy parts.</p>
</div>
<div class="paragraph">
<p>You’ll see <strong>TypeScript code</strong> for OmniQueue, <strong>Mermaid diagrams</strong> for system flows, and <strong>cheat sheets</strong> for quick reference.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reader_expectations">Reader Expectations</h3>
<div class="ulist">
<ul>
<li>
<p>You don’t need to be a messaging expert — but some familiarity with distributed systems will help.</p>
</li>
<li>
<p>You should be comfortable reading TypeScript and basic CLI commands.</p>
</li>
<li>
<p>Expect real-world complexity: we’ll talk about failures, quirks, and debugging nightmares.</p>
</li>
<li>
<p>We’ll show both the “happy path” and the “when it all goes wrong” path.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_this_book_is_organized">How This Book Is Organized</h3>
<table class="tableblock frame-all grid-all stretch text-center">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Part</th>
<th class="tableblock halign-left valign-top">Focus</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messaging fundamentals and OmniQueue core API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">II</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deep dives into individual brokers with OmniQueue mapping.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">III</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advanced OmniQueue usage, scaling, and tuning.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Real-world implementations and case studies.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">V</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extending and contributing to OmniQueue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Appendices</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quick references, glossary, and disaster checklists.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_our_promise">Our Promise</h3>
<div class="paragraph">
<p>By the end of this book, you’ll be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand the trade-offs between major messaging systems.</p>
</li>
<li>
<p>Confidently implement broker-agnostic messaging in your projects.</p>
</li>
<li>
<p>Operate and troubleshoot OmniQueue in production.</p>
</li>
<li>
<p>Extend OmniQueue to support new brokers and patterns.</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Messaging is not just about moving data.
It’s about shaping the <strong>lifeblood</strong> of your system — reliably, predictably, and with intent.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; From the Authors
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_use_this_book">How to Use This Book</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This book is both a <strong>reference</strong> and a <strong>journey</strong>.
You can read it cover-to-cover or jump directly to the sections that matter most to your work.</p>
</div>
<div class="paragraph">
<p>We’ve designed it with multiple entry points, so whether you are brand-new to messaging or a seasoned architect managing a multi-broker fleet, you’ll find value.</p>
</div>
<div class="sect2">
<h3 id="_reading_paths_by_experience_tier">Reading Paths by Experience Tier</h3>
<div class="paragraph">
<p>We’ve tagged content for different levels of experience.
If you identify your tier, you can follow the recommended path:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Beginner (0–2 years)</strong>
Start with Part I: <strong>Messaging Fundamentals</strong> (Chapters 1–3).
These chapters introduce core concepts and get you hands-on with OmniQueue quickly.
Then, read only the broker chapters (Part II) for the systems you’ll use in your current work.</p>
</li>
<li>
<p><strong>Intermediate (2–5 years)</strong>
You can skim Part I for a refresher, then dive deep into the broker chapters (Part II).
Pay attention to <strong>War Stories</strong> and <strong>Cheat Sheets</strong> — they’ll save you pain in production.
Follow with Part III to learn scaling, monitoring, and advanced OmniQueue patterns.</p>
</li>
<li>
<p><strong>Senior Engineer / Architect (5+ years)</strong>
Jump to the broker chapters you care about most, but don’t skip Part III — it’s packed with operational patterns for high-scale environments.
Use Part IV’s case studies for inspiration and validation of architectural decisions.</p>
</li>
<li>
<p><strong>OmniQueue Mastery Mode</strong>
These sections are sprinkled throughout the book for readers who want to extend OmniQueue itself.
You’ll find them in both broker chapters and advanced sections.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_part_by_part_guide">Part-by-Part Guide</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Part</th>
<th class="tableblock halign-left valign-top">How to Use It</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foundation for messaging concepts and OmniQueue basics. Best for new readers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">II</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Broker-specific knowledge. Each chapter is standalone — read only what you need.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">III</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advanced OmniQueue usage: scaling, observability, disaster recovery.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Real-world case studies — learn from actual deployments and failures.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">V</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contribution and extension — for those building on or contributing to OmniQueue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Appendices</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quick-reference materials, glossary, and operational checklists.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_code_examples">Code Examples</h3>
<div class="paragraph">
<p>All OmniQueue examples are in <strong>TypeScript</strong>.
We assume you have basic familiarity with <code>npm</code>, <code>pnpm</code>, or <code>yarn</code> and Node.js tooling.</p>
</div>
<div class="paragraph">
<p>Code listings are annotated with comments to explain <strong>why</strong> something is done, not just <strong>how</strong>.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="c1">// Sending a message with OmniQueue</span>
<span class="k">await</span> <span class="nx">omni</span><span class="p">.</span><span class="nf">send</span><span class="p">({</span>
  <span class="na">destination</span><span class="p">:</span> <span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">body</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1234</span><span class="dl">'</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">confirmed</span><span class="dl">'</span> <span class="p">},</span>
  <span class="na">group</span><span class="p">:</span> <span class="dl">'</span><span class="s1">order-processing</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// Required for consumers</span>
  <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Create destination if it doesn't exist</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whenever we compare OmniQueue to a native broker API, we show them side-by-side for clarity.</p>
</div>
</div>
<div class="sect2">
<h3 id="_diagrams_and_visuals">Diagrams and Visuals</h3>
<div class="paragraph">
<p>We use <strong>Mermaid diagrams</strong> for flows, topologies, and message lifecycles.
These are rendered in the book, but if you’re reading the raw AsciiDoc, you can copy the code into any Mermaid-compatible renderer to visualize it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cheat_sheets_and_war_stories">Cheat Sheets and War Stories</h3>
<div class="paragraph">
<p>At the end of each broker chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Cheat Sheet</strong> — quick reference for commands, configs, metrics, and a <strong>disaster checklist</strong>.</p>
</li>
<li>
<p><strong>War Stories</strong> — short narratives of real-world incidents, failures, and their solutions.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cross_references">Cross-References</h3>
<div class="paragraph">
<p>Throughout the book, cross-references (e.g., “see &lt;&lt;\_chapter\_3&gt;&gt;”) help you connect concepts.
We strongly encourage following them, especially when exploring advanced topics that build on earlier material.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_youll_need">What You’ll Need</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Node.js</strong> 18+</p>
</li>
<li>
<p>A package manager (<code>npm</code>, <code>pnpm</code>, or <code>yarn</code>)</p>
</li>
<li>
<p>Docker (optional, but useful for running brokers locally)</p>
</li>
<li>
<p>Basic terminal familiarity</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You don’t need to install every broker at once — we’ll give setup instructions per chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_our_advice">Our Advice</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Don’t just read — run the examples.</strong>
Messaging is best learned by sending and receiving real messages.</p>
</li>
<li>
<p><strong>Experiment with failure.</strong>
Kill brokers, drop connections, overload queues — see how systems behave under stress.</p>
</li>
<li>
<p><strong>Adapt patterns to your context.</strong>
There’s no universal “right” way; use these patterns as starting points.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_chapter_1_introduction">1. Chapter 1: Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_role_of_messaging_in_modern_systems">1.1. The Role of Messaging in Modern Systems</h3>
<div class="paragraph">
<p>Messaging is the circulatory system of distributed software.</p>
</div>
<div class="paragraph">
<p>Whether you are processing financial transactions, streaming telemetry from millions of IoT devices, or fanning out notifications to mobile users, <strong>messages</strong> are how your system communicates internally and externally.</p>
</div>
<div class="paragraph">
<p>Unlike synchronous HTTP calls, messaging systems decouple producers and consumers in <strong>time</strong> and <strong>space</strong>.
This makes them a cornerstone of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Scalability</strong> — handle bursts by buffering messages in queues, logs, or streams.</p>
</li>
<li>
<p><strong>Resilience</strong> — retry failed deliveries without dropping data.</p>
</li>
<li>
<p><strong>Loose coupling</strong> — evolve services independently.</p>
</li>
<li>
<p><strong>Asynchronous workflows</strong> — free services from waiting on each other.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Modern architectures like <strong>microservices</strong>, <strong>event-driven systems</strong>, and <strong>CQRS/ES</strong> (Command Query Responsibility Segregation / Event Sourcing) rely heavily on messaging.</p>
</div>
</div>
<div class="sect2">
<h3 id="_brokered_vs_brokerless_messaging">1.2. Brokered vs. Brokerless Messaging</h3>
<div class="paragraph">
<p>Messaging systems come in two broad categories:</p>
</div>
<table id="table-brokered-brokerless" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Brokered Vs Brokerless</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Brokered</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messages flow through a central server (the broker) that stores, routes, and delivers them.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RabbitMQ, Kafka, NATS JetStream, ActiveMQ Artemis, Azure Service Bus, Apache Pulsar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Brokerless</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Producers send messages directly to consumers without an intermediary. Often implemented with peer-to-peer sockets.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZeroMQ, nanomsg</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Brokered systems</strong> offer durability, routing flexibility, and operational control.
<strong>Brokerless systems</strong> excel in speed, simplicity, and deployment independence.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_fragmentation_problem">1.3. The Fragmentation Problem</h3>
<div class="paragraph">
<p>Each broker ecosystem has its <strong>own</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API shape and naming conventions</p>
</li>
<li>
<p>Delivery semantics (at-most-once, at-least-once, exactly-once)</p>
</li>
<li>
<p>Terminology: <strong>queue</strong> vs <strong>topic</strong>, <strong>exchange</strong> vs <strong>stream</strong>, <strong>subject</strong> vs <strong>channel</strong></p>
</li>
<li>
<p>Operational model and deployment pattern</p>
</li>
<li>
<p>Performance characteristics and tuning knobs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Moving from RabbitMQ to Kafka isn’t just a config change — it’s often a <strong>rewrite</strong>.
Even within the same organization, different teams may adopt different brokers for historical or domain-specific reasons.</p>
</div>
<div class="paragraph">
<p>This leads to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Code duplication</strong> — multiple code paths for different brokers.</p>
</li>
<li>
<p><strong>Vendor lock-in</strong> — hard to migrate away.</p>
</li>
<li>
<p><strong>Operational complexity</strong> — separate tooling, metrics, and expertise required.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_enter_omniqueue">1.4. Enter OmniQueue</h3>
<div class="paragraph">
<p>OmniQueue addresses the fragmentation problem with a <strong>unified, broker-agnostic API</strong> centered on <strong>publish/subscribe with mandatory consumer groups</strong>.</p>
</div>
<div class="paragraph">
<p>Producers <strong>publish</strong> to a <strong>topic</strong>.
Each <strong>consumer group</strong> subscribed to that topic receives a copy of every message; within a given group, only one consumer processes a given message.</p>
</div>
<div class="paragraph">
<p>Handlers acknowledge with <code>ack()</code> or <code>nack(requeue?: boolean)</code>.</p>
</div>
<div id="fig-a-look-on-topic-messaging" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/a-look-on-topic-messaging-90446a0dbe817bb5fbf10b12c17d84c4c4a46bcff4aa6a1d20c5fed0ad67a2b7.png" alt="A look on &quot;topic&quot; messaging" width="600" height="600">
</div>
<div class="title">Figure 1. A look on "topic" messaging</div>
</div>
<div class="paragraph">
<p>With OmniQueue, your code can switch between brokers with minimal changes, while still leveraging advanced features through <strong>broker adapters</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_simple_example">1.5. A Simple Example</h3>
<div id="code-a-look-on-omniqueue-code" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">import</span> <span class="p">{</span> <span class="nx">create</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@omniqueue/core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">@omniqueue/rabbitmq</span><span class="dl">'</span><span class="p">;</span> <span class="c1">// registers the "rabbitmq" adapter</span>

<span class="c1">// Create and init a broker instance</span>
<span class="kd">const</span> <span class="nx">broker</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">create</span><span class="p">(</span><span class="dl">'</span><span class="s1">rabbitmq</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">amqp://localhost</span><span class="dl">'</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">init</span><span class="p">();</span>

<span class="c1">// Publisher: send one event to the topic "orders"</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ulid-01JABCDEF...</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span> <span class="na">orderId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">A123</span><span class="dl">'</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">confirmed</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">x-source</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">checkout</span><span class="dl">'</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// lazily create the destination if missing</span>
    <span class="c1">// createOptions can pass through to the adapter (durable, partitions, etc.)</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Subscriber: each GROUP receives a copy; work is shared inside the group.</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span>
  <span class="k">async </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Processing order</span><span class="dl">'</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">ack</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">nack</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// requeue on error</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="dl">'</span><span class="s1">order-service</span><span class="dl">'</span><span class="p">,</span>    <span class="c1">// &lt;-- mandatory groupId</span>
  <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>    <span class="c1">// optional ConsumeOptions</span>
<span class="p">);</span>

<span class="c1">// ...later, graceful shutdown</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Switching to Kafka, NATS, Pulsar, or another supported broker means changing only the adapter import and connection config — your core logic stays the same.</p>
</div>
</div>
<div class="sect2">
<h3 id="_who_uses_omniqueue">1.6. Who Uses OmniQueue?</h3>
<div class="paragraph">
<p>OmniQueue is designed for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Polyglot microservice environments</strong> — where different teams choose different brokers.</p>
</li>
<li>
<p><strong>Hybrid cloud architectures</strong> — where on-prem and cloud-native brokers must coexist.</p>
</li>
<li>
<p><strong>Migration projects</strong> — moving from one broker to another without downtime.</p>
</li>
<li>
<p><strong>Prototyping and R\&amp;D</strong> — quickly test message flows across multiple systems.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_what_this_chapter_sets_up">1.7. What This Chapter Sets Up</h3>
<div class="paragraph">
<p>In the chapters ahead:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Chapter 2</strong> will cover <strong>Core Messaging Concepts</strong> in detail — topics, routing, delivery guarantees, and reliability.</p>
</li>
<li>
<p><strong>Chapter 3</strong> will dissect <strong>OmniQueue Architecture &amp; Core API</strong>, showing exactly how the abstraction is implemented with <code>publish</code>/<code>subscribe</code>.</p>
</li>
<li>
<p><strong>Part II</strong> will then dive deep into individual brokers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The goal of this introduction is simple:
Give you the “why” and the “what” before we explore the “how” and “when”.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_messaging_concepts">2. Core Messaging Concepts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_messages_queues_topics_streams">2.1. Messages, Queues, Topics, Streams</h3>
<div class="paragraph">
<p>At the heart of any messaging system is the <strong>message</strong>:
a discrete unit of data that moves from producer to consumer.</p>
</div>
<div class="sect3">
<h4 id="_the_message_structure">2.1.1. The Message Structure</h4>
<div class="paragraph">
<p>While brokers differ in terminology and features, most messages contain:</p>
</div>
<table id="table-message-components" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Message components</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ID</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uniquely identifies the message.
For durability and traceability, many teams use ULID or UUID v7. Some brokers provide their own sequence IDs (Kafka offset, Pulsar ledgerId/entryId, etc.).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Body</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The actual payload.
Often JSON for ease of debugging, but formats like Avro or Protobuf are preferred in high-performance or schema-validated environments.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Headers / Attributes</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metadata about the message (e.g., <code>content-type</code>, source service, trace IDs for distributed tracing, tenant identifiers).
These can influence routing (e.g., header-based exchange in RabbitMQ) or serve for observability.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In OmniQueue, <code>body</code> is always JSON-serialisable to ensure adapter compatibility, but you can base64-encode binary payloads if needed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_queues">2.1.2. Queues</h4>
<div class="paragraph">
<p>A <strong>queue</strong> is a named, ordered collection of messages that delivers each message to exactly one consumer within a given group.
When a message is acknowledged (<code>ack()</code>), it is removed from the queue (or marked processed).</p>
</div>
<div class="paragraph">
<p><strong>Key characteristics:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>FIFO order</strong> by default, though some brokers allow priority or sharded ordering.</p>
</li>
<li>
<p><strong>Work sharing</strong> — multiple consumers in the same group share the load.</p>
</li>
<li>
<p><strong>Backpressure</strong> — unacknowledged messages accumulate in the queue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Real-world usage:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Task processing (image rendering, report generation).</p>
</li>
<li>
<p>Decoupling request spikes from downstream processing.</p>
</li>
<li>
<p>Buffering workloads when downstream systems are slow.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_topics">2.1.3. Topics</h4>
<div class="paragraph">
<p>A <strong>topic</strong> is a named channel to which producers publish and consumers subscribe.</p>
</div>
<div class="paragraph">
<p><strong>Key characteristics:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Fanout delivery</strong> — every consumer group subscribed to a topic gets a full copy of the message stream.</p>
</li>
<li>
<p><strong>Group semantics</strong> — within a single group, messages are load-balanced to one consumer at a time.</p>
</li>
<li>
<p><strong>Loose coupling</strong> — producers don’t need to know who consumes their messages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Real-world usage:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event broadcasting (order events, user activity streams).</p>
</li>
<li>
<p>Multi-service pipelines (analytics, fraud detection, notifications).</p>
</li>
<li>
<p>Event sourcing feeds.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_streams">2.1.4. Streams</h4>
<div class="paragraph">
<p>A <strong>stream</strong> is an append-only, immutable sequence of messages stored in durable storage.
Consumers track their own <strong>offset</strong> (position) and can replay older messages at will.</p>
</div>
<div class="paragraph">
<p>Key characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Messages persist</strong> for a retention period (e.g., 7 days) or indefinitely.</p>
</li>
<li>
<p><strong>Multiple independent consumers</strong> — each with their own offsets.</p>
</li>
<li>
<p><strong>High throughput</strong> by avoiding message deletion.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Real-world usage:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Audit logging with replay.</p>
</li>
<li>
<p>Rebuilding projections in CQRS systems.</p>
</li>
<li>
<p>Time-series analytics pipelines.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_comparing_destinations">2.1.5. Comparing Destinations</h4>
<table id="table-queue-vs-topic-vs-stream" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Queue Vs Topic Vs Stream</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Delivery Model</th>
<th class="tableblock halign-left valign-top">Storage &amp; Retention</th>
<th class="tableblock halign-left valign-top">Replay Support</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point-to-point within a group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message removed after ack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Publish/subscribe, fanout to groups</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Broker-controlled, may persist temporarily</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sometimes (depends on broker)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Publish/subscribe with offset tracking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long-term retention in log</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div id="ch2-queue-topic-stream" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch2-queue-topic-stream-3232893687c00609a034f04c308e601610cee4fbedea36963ab57deca899c23b.png" alt="Queue, Topic, Stream">
</div>
<div class="title">Figure 2. Queue, Topic, Stream</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_brokers_vs_brokerless">2.2. Brokers vs. Brokerless</h3>
<div class="sect3">
<h4 id="_what_is_a_broker">2.2.1. What is a Broker?</h4>
<div class="paragraph">
<p>A <strong>broker</strong> is a dedicated server (or cluster) that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Accepts messages from producers via network protocols (AMQP, Kafka protocol, MQTT, HTTP).</p>
</li>
<li>
<p>Routes them based on metadata (exchange bindings, partition keys, headers).</p>
</li>
<li>
<p>Stores them (in memory, disk, or distributed logs) for durability and later delivery.</p>
</li>
<li>
<p>Delivers them to consumers, tracking acknowledgements.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples: RabbitMQ, Kafka, NATS JetStream, ActiveMQ Artemis, Azure Service Bus, Apache Pulsar.</p>
</div>
<div class="paragraph">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Durability</strong> — messages survive restarts or crashes.</p>
</li>
<li>
<p><strong>Routing flexibility</strong> — fanout, topic filters, header matching, partitioning.</p>
</li>
<li>
<p><strong>Operational visibility</strong> — metrics, queues, consumer lag.</p>
</li>
<li>
<p><strong>Security controls</strong> — authentication, authorization, encryption.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Challenges:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operational cost — needs monitoring, scaling, patching.</p>
</li>
<li>
<p>Latency vs. durability trade-offs — fsyncs, replication.</p>
</li>
<li>
<p>Complexity — tuning partitions, queues, consumers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_brokerless_messaging">2.2.2. Brokerless Messaging</h4>
<div class="paragraph">
<p>In <strong>brokerless</strong> systems, producers send messages directly to consumers without an intermediary server.
Typically, these use <strong>peer-to-peer sockets</strong> or multicast protocols.</p>
</div>
<div class="paragraph">
<p>Example: ZeroMQ’s PUB/SUB, PUSH/PULL patterns.</p>
</div>
<div class="paragraph">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ultra-low latency</strong> — no queue persistence or broker hop.</p>
</li>
<li>
<p><strong>No single point of failure</strong> — as long as consumers are reachable.</p>
</li>
<li>
<p><strong>Lightweight deployment</strong> — often just a library in your app.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Challenges:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>No inherent durability — offline consumers miss messages.</p>
</li>
<li>
<p>No centralized management — must handle discovery, retries, ordering yourself.</p>
</li>
<li>
<p>Difficult scaling for complex topologies.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_visual_comparison">2.2.3. Visual Comparison</h4>
<div id="ch2-broker-vs-brokerless" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch2-broker-vs-brokerless-a010235679bf318d118d4430e7fc7893e95fff1dbcabea5cdadbd064d15ab92f.png" alt="Brokered Vs Brokerless">
</div>
<div class="title">Figure 3. Brokered Vs Brokerless</div>
</div>
<div class="paragraph">
<p><strong>Brokered systems</strong> shine in reliability and complexity management.
<strong>Brokerless systems</strong> shine in simplicity and speed — but require discipline in application design.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
OmniQueue supports <strong>both</strong> worlds. A <code>@omniqueue/zeromq</code> adapter can connect directly between processes without a broker, while <code>@omniqueue/kafka</code>, <code>@omniqueue/rabbitmq</code>, and others leverage durable, clustered brokers.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_delivery_semantics">2.3. Delivery Semantics</h3>
<div class="paragraph">
<p>Delivery semantics define <strong>how many times</strong> a message is delivered to a consumer, and under what guarantees.
They are a cornerstone of messaging design — the choice affects performance, complexity, and data correctness.</p>
</div>
<div class="sect3">
<h4 id="_at_most_once">2.3.1. At-most-once</h4>
<div class="paragraph">
<p><strong>Definition:</strong></p>
</div>
<div class="paragraph">
<p>A message is delivered <strong>zero or one time</strong>, but never more than once.
If the delivery fails, the message is lost — no retries.</p>
</div>
<div class="paragraph">
<p><strong>How it happens:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The broker (or producer in brokerless systems) sends the message without waiting for acknowledgement.</p>
</li>
<li>
<p>No redelivery is attempted if the consumer fails mid-processing.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Pros:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lowest latency — no ack/nack overhead.</p>
</li>
<li>
<p>Simplest implementation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cons:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data loss possible under failures.</p>
</li>
<li>
<p>Not suitable for critical workflows.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Real-world usage:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Non-critical telemetry where occasional loss is acceptable (e.g., live UI metrics).</p>
</li>
<li>
<p>High-frequency, low-value sensor data.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_at_least_once">2.3.2. At-least-once</h4>
<div class="paragraph">
<p><strong>Definition:</strong></p>
</div>
<div class="paragraph">
<p>A message is delivered <strong>one or more times</strong> until it is acknowledged.
Duplicates may occur.</p>
</div>
<div class="paragraph">
<p><strong>How it happens:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The broker stores the message until it gets an explicit ack from the consumer.</p>
</li>
<li>
<p>If ack is not received within a timeout or connection drops, the broker redelivers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Pros:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>No message loss under normal broker persistence guarantees.</p>
</li>
<li>
<p>The default for most brokers (RabbitMQ, SQS, NATS JetStream).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cons:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Requires <strong>idempotent</strong> consumers — they must handle duplicates gracefully.</p>
</li>
<li>
<p>Potential extra load from duplicate processing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Real-world usage:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Payment processing (with idempotency keys).</p>
</li>
<li>
<p>Order event processing.</p>
</li>
<li>
<p>Logging pipelines.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_exactly_once">2.3.3. Exactly-once</h4>
<div class="paragraph">
<p><strong>Definition:</strong></p>
</div>
<div class="paragraph">
<p>A message is delivered <strong>exactly one time</strong> — no duplicates, no losses.</p>
</div>
<div class="paragraph">
<p><strong>How it happens:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Requires transactional coordination between producer, broker, and consumer.</p>
</li>
<li>
<p>The broker and consumer commit offsets/state atomically.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Pros:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simplest for consumers — no deduplication logic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cons:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>High complexity, often broker-specific.</p>
</li>
<li>
<p>Lower throughput due to transactional overhead.</p>
</li>
<li>
<p>Often misunderstood — "exactly-once" guarantees are fragile in distributed systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Real-world usage:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Financial transaction settlement (Kafka + idempotent producers + transactions).</p>
</li>
<li>
<p>Highly sensitive event processing.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_omniqueue_perspective">2.3.4. OmniQueue Perspective</h4>
<div class="paragraph">
<p>OmniQueue does not enforce a delivery semantic by itself — it passes through the broker&#8217;s native behavior.
However:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At-least-once is the most common.</p>
</li>
<li>
<p>You can achieve effectively-once delivery by combining at-least-once brokers with idempotent consumer logic.</p>
</li>
<li>
<p>Broker adapters may expose native exactly-once features (e.g., Kafka transactions) via <code>createOptions</code> or broker-specific APIs.</p>
</li>
</ul>
</div>
<div id="ch2-delivery-semantics" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch2-delivery-semantics-c50a3ba1b95ec8b2ae04cc36e52fc2cf168107f552c4e48a1201e177a56b1928.png" alt="Delivery Semantics">
</div>
<div class="title">Figure 4. Delivery Semantics</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reliability_durability">2.4. Reliability &amp; Durability</h3>
<div class="sect3">
<h4 id="_reliability">2.4.1. Reliability</h4>
<div class="paragraph">
<p>Reliability is the ability of a messaging system to deliver messages as promised, even under faults.
It depends on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Acknowledgements</strong> — explicit <code>ack()</code>/<code>nack()</code> calls.</p>
</li>
<li>
<p><strong>Retries</strong> — redelivery on failure.</p>
</li>
<li>
<p><strong>Consumer groups</strong> — work sharing without loss.</p>
</li>
<li>
<p><strong>Dead-letter queues (DLQ)</strong> — holding unprocessable messages for inspection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operational tips:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set sensible retry limits — infinite retries can overload systems.</p>
</li>
<li>
<p>Use DLQs to capture poison messages (malformed or consistently failing).</p>
</li>
<li>
<p>Monitor consumer lag — large lag indicates bottlenecks.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_durability">2.4.2. Durability</h4>
<div class="paragraph">
<p>Durability ensures messages survive broker or system restarts.
This requires <strong>persistent storage</strong> at the broker level.</p>
</div>
<div class="paragraph">
<p>Common strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Disk persistence</strong> — messages are written to disk (RabbitMQ durable queues, Kafka logs).</p>
</li>
<li>
<p><strong>Replication</strong> — messages are stored on multiple nodes (Kafka ISR, Pulsar BookKeeper).</p>
</li>
<li>
<p><strong>Acknowledgement after fsync</strong> — broker only acks after writing to stable storage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Trade-offs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Durability often increases latency.</p>
</li>
<li>
<p>Replication adds network cost but prevents data loss from node failure.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_durability_in_omniqueue_context">2.4.3. Durability in OmniQueue Context</h4>
<div class="paragraph">
<p>OmniQueue’s durability depends entirely on the broker adapter in use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RabbitMQ Adapter</strong> — durable queues + persistent messages.</p>
</li>
<li>
<p><strong>Kafka Adapter</strong> — log-based storage with configurable replication factor.</p>
</li>
<li>
<p><strong>NATS JetStream Adapter</strong> — file or memory storage with optional replication.</p>
</li>
<li>
<p><strong>ZeroMQ Adapter</strong> — no built-in durability (application must handle persistence).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can influence durability in OmniQueue via <code>createOptions</code> when calling <code>publish()</code> or <code>subscribe()</code>, passing through broker-specific flags.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div id="code-omniqueue-publish" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="p">{...},</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">createOptions</span><span class="p">:</span> <span class="p">{</span> <span class="na">durable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">replicationFactor</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div id="ch2-durability-lifecycle" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch2-durability-lifecycle-f0d09b73513fbc76b9b4daa1bbede8cc1a90741f8bb42d5e3f3414bc86530631.png" alt="Durability Lifecycle">
</div>
<div class="title">Figure 5. Durability Lifecycle</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you don’t configure durability in the broker, OmniQueue can’t “make it durable” — always set it explicitly in <code>createOptions</code> when the workload demands it.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load_balancing_consumer_groups">2.5. Load Balancing &amp; Consumer Groups</h3>
<div class="paragraph">
<p>In messaging systems, <strong>load balancing</strong> is about distributing work evenly among multiple consumers to improve throughput and avoid overloading any single consumer.</p>
</div>
<div class="sect3">
<h4 id="_consumer_groups">2.5.1. Consumer Groups</h4>
<div class="paragraph">
<p>A <strong>consumer group</strong> is a named set of consumers that share the work of processing messages from a topic or queue.</p>
</div>
<div class="paragraph">
<p>Key characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Work-sharing</strong>:
Each message is processed by exactly <strong>one</strong> consumer in the group.</p>
</li>
<li>
<p><strong>Isolation between groups</strong>:
Multiple groups can subscribe to the same topic, each getting its <strong>own full copy</strong> of the messages.</p>
</li>
<li>
<p><strong>Scaling</strong>:
Adding more consumers to a group increases parallelism; removing consumers reduces throughput but not reliability.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OmniQueue enforces <strong>mandatory consumer groups</strong> — every <code>subscribe()</code> call must specify a <code>groupId</code>.
This makes semantics explicit and avoids accidental fanout to unintended consumers.</p>
</div>
<div class="paragraph">
<p>Example with OmniQueue:</p>
</div>
<div id="code-example-subcribe" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span>
  <span class="k">async </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`[Worker] Processing order </span><span class="p">${</span><span class="nx">msg</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">ack</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="dl">'</span><span class="s1">order-service</span><span class="dl">'</span><span class="p">,</span>       <span class="c1">// groupId</span>
  <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_consumer_group_dynamics">2.5.2. Consumer Group Dynamics</h4>
<div class="ulist">
<ul>
<li>
<p>If a consumer in a group fails mid-processing: The broker reassigns its unacknowledged messages to other consumers in the same group.</p>
</li>
<li>
<p>If more consumers join the group: The broker redistributes partitions or message streams to balance the load.</p>
</li>
</ul>
</div>
<div id="ch2-consumer-group-dynamics" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch2-consumer-group-dynamics-b2e9ee7ca1ba3fd07829cfc0f82d3acfdf4f70fba92d4f3bbab8a575ec006a48.png" alt="Consumer Group Dynamics">
</div>
<div class="title">Figure 6. Consumer Group Dynamics</div>
</div>
</div>
<div class="sect3">
<h4 id="_load_balancing_patterns">2.5.3. Load Balancing Patterns</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Static partition assignment</strong> (Kafka, Pulsar):
Each consumer gets a fixed set of partitions.</p>
</li>
<li>
<p><strong>Dynamic work stealing</strong> (RabbitMQ, NATS JetStream):
Consumers pull messages as they become available.</p>
</li>
<li>
<p><strong>Broker push with credit flow control</strong>:
Broker pushes messages but limits in-flight count per consumer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Operational considerations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Monitor <strong>consumer lag</strong> per group.</p>
</li>
<li>
<p>Keep consumer processing times balanced — slow consumers can cause uneven workloads.</p>
</li>
<li>
<p>In idempotent systems, you can temporarily run the same consumer logic in multiple groups for migration or testing.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pubsub_fanout_vs_point_to_point">2.6. Pub/Sub (Fanout) vs. Point-to-Point</h3>
<div class="sect3">
<h4 id="_point_to_point_p2p">2.6.1. Point-to-Point (P2P)</h4>
<div class="paragraph">
<p>In <strong>point-to-point</strong> messaging:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A message is sent to a <strong>queue</strong>.</p>
</li>
<li>
<p>Exactly one consumer within the target group processes it.</p>
</li>
<li>
<p>Once acknowledged, the message is removed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Pros:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensures work is processed only once per group.</p>
</li>
<li>
<p>Easy to reason about load balancing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cons:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>No automatic duplication to other consumers outside the group.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Real-world usage:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Task queues (image processing jobs).</p>
</li>
<li>
<p>Distributed workers for batch workloads.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_publishsubscribe_fanout">2.6.2. Publish/Subscribe (Fanout)</h4>
<div class="paragraph">
<p>In <strong>publish/subscribe</strong> messaging:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Producers send to a <strong>topic</strong>.</p>
</li>
<li>
<p>Each subscribed group gets a <strong>full copy</strong> of each message.</p>
</li>
<li>
<p>Inside each group, messages are load-balanced.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Pros:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multiple services can independently react to the same event stream.</p>
</li>
<li>
<p>Decouples event producers from consumers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cons:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>More storage and network usage if many groups subscribe.</p>
</li>
<li>
<p>Need to manage schema and compatibility carefully.</p>
</li>
</ul>
</div>
<div id="ch2-pubsub-vs-p2p" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch2-pubsub-vs-p2p-9728cc4b6912e05b4513b53211dee708e51a33b25f5be511d9b0bf68a13b6d05.png" alt="Pubsub Vs P2P">
</div>
<div class="title">Figure 7. Pubsub Vs P2P</div>
</div>
</div>
<div class="sect3">
<h4 id="_omniqueues_approach">2.6.3. OmniQueue’s Approach</h4>
<div class="paragraph">
<p>OmniQueue <strong>always</strong> uses publish/subscribe semantics at the API level:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>publish(topic, message, opts?)</code> — send to a topic.</p>
</li>
<li>
<p><code>subscribe(topic, handler, groupId, opts)</code> — join a group to consume messages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This allows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Point-to-point</strong> — by having only one group for a topic.</p>
</li>
<li>
<p><strong>Fanout</strong> — by having multiple groups subscribed to the same topic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This design unifies the two models, and the behavior depends on how you name and organize your groups.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div id="code-example-multiple-subcribe" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="c1">// Point-to-point: single group</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="dl">'</span><span class="s1">order-service</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="c1">// Fanout: multiple groups get all events</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handler1</span><span class="p">,</span> <span class="dl">'</span><span class="s1">fraud-check</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handler2</span><span class="p">,</span> <span class="dl">'</span><span class="s1">analytics</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_omniqueue_architecture_core_api">3. OmniQueue Architecture &amp; Core API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_design_principles">3.1. Overview &amp; Design Principles</h3>
<div class="paragraph">
<p>OmniQueue is a <strong>broker-agnostic messaging abstraction</strong> written in TypeScript.
Its core purpose is to provide a <strong>single, unified API</strong> for producing and consuming messages across a wide range of messaging technologies — both brokered (e.g., RabbitMQ, Kafka, Pulsar) and brokerless (e.g., ZeroMQ).</p>
</div>
<div class="paragraph">
<p>The architecture is designed to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unify, not oversimplify</strong>:
Provide consistent <code>publish</code> and <code>subscribe</code> semantics while still exposing broker-specific options via <code>createOptions</code> when needed.</p>
</li>
<li>
<p><strong>Preserve advanced features</strong>:
Let developers use native capabilities of each broker without breaking the abstraction.</p>
</li>
<li>
<p><strong>Enforce explicitness</strong>:
OmniQueue requires <code>groupId</code> for every subscription — avoiding accidental broadcast to unintended consumers.</p>
</li>
<li>
<p><strong>Support both high-level productivity and low-level control</strong>:
Developers can start quickly but still configure performance, durability, and topology deeply.</p>
</li>
<li>
<p><strong>Be modular</strong>:
Each broker is implemented as a separate adapter that can be loaded dynamically.</p>
</li>
<li>
<p><strong>Be lifecycle-conscious</strong>:
Connection management (<code>init</code>, <code>close</code>) is explicit to encourage clean startup/shutdown patterns.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OmniQueue’s <strong>core runtime</strong> is small and stable.
It handles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Broker registration</strong> (via the plugin registry).</p>
</li>
<li>
<p><strong>Factory creation</strong> of broker instances.</p>
</li>
<li>
<p><strong>Delegation</strong> of operations (<code>publish</code>, <code>subscribe</code>) to the active adapter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Adapters handle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Protocol specifics</strong> (AMQP, Kafka wire protocol, ZeroMQ sockets, etc.).</p>
</li>
<li>
<p><strong>Broker-specific topology creation</strong>.</p>
</li>
<li>
<p><strong>Mapping of OmniQueue concepts</strong> (topics, groups) to the broker’s native constructs.</p>
</li>
</ul>
</div>
<div id="ch3-architecture-layers" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch3-architecture-layers-93f7f1fa8bfea1a249700f94a26da5032c33aa03cd659ff85de2822c9dacfced.png" alt="OmniQueue Design Layers">
</div>
<div class="title">Figure 8. OmniQueue Design Layers</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This separation means that adding support for a new broker is as simple as writing an adapter and registering it with <code>register('provider-name', factoryFn)</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_core_api_publish_and_subscribe">3.2. Core API: publish and subscribe</h3>
<div class="paragraph">
<p>OmniQueue’s runtime exposes two primary operations for message flow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>publish</strong> — send a message to a topic so it can be consumed by one or more groups.</p>
</li>
<li>
<p><strong>subscribe</strong> — join a consumer group to receive messages from a topic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This section documents their signatures, parameters, and usage patterns.</p>
</div>
<div class="sect3">
<h4 id="_publish">3.2.1. publish()</h4>
<div class="paragraph">
<p>Sends a message to a given topic. All consumer groups subscribed to that topic will receive a copy.
Within each group, only one consumer processes the message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="nf">publish</span><span class="p">(</span>
  <span class="nx">topic</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
  <span class="nx">msg</span><span class="p">:</span> <span class="nb">Omit</span><span class="o">&lt;</span><span class="nx">BrokerMessage</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ack</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">nack</span><span class="dl">'</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">opts</span><span class="p">?:</span> <span class="nx">SendOptions</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Parameters:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>topic</code>: Name of the topic (string).</p>
</li>
<li>
<p>Naming is case-sensitive for most brokers.</p>
</li>
<li>
<p><code>msg</code>: Message to send, without the <code>ack</code> and <code>nack</code> methods.</p>
</li>
<li>
<p>Must include <code>id</code>, <code>body</code>, and <code>headers</code>.</p>
</li>
<li>
<p><code>opts</code>: Optional <code>SendOptions</code>:</p>
</li>
<li>
<p><code>prio</code>: Message priority (broker-dependent).</p>
</li>
<li>
<p><code>ensure</code>: Create the topic/queue/stream if it doesn’t exist.</p>
</li>
<li>
<p><code>createOptions</code>: Broker-specific creation parameters (durability, partitions, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Example:</strong></p>
</div>
<div id="code-publish-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">01JABCDE123...</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span> <span class="na">orderId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">A123</span><span class="dl">'</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">confirmed</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">x-source</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">checkout-service</span><span class="dl">'</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">createOptions</span><span class="p">:</span> <span class="p">{</span> <span class="na">durable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_subscribe">3.2.2. subscribe()</h4>
<div class="paragraph">
<p>Listens for messages on a topic as part of a specific consumer group.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="nf">subscribe</span><span class="p">(</span>
  <span class="nx">topic</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
  <span class="nx">handler</span><span class="p">:</span> <span class="p">(</span><span class="nx">m</span><span class="p">:</span> <span class="nx">BrokerMessage</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">groupId</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
  <span class="nx">opts</span><span class="p">:</span> <span class="nx">ConsumeOptions</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Parameters:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>topic</code>: Name of the topic (string).</p>
</li>
<li>
<p><code>handler</code>: Async function that processes each message.</p>
</li>
<li>
<p>Receives a <code>BrokerMessage</code> with <code>ack()</code> and <code>nack()</code> methods.</p>
</li>
<li>
<p>Must call <code>ack()</code> on success, or <code>nack(requeue?: boolean)</code> on failure.</p>
</li>
<li>
<p><code>groupId</code>: Mandatory group identifier for work-sharing.</p>
</li>
<li>
<p><code>opts</code>: Optional <code>ConsumeOptions</code> (inherits all <code>SendOptions</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Example:</strong></p>
</div>
<div id="code-subscribe-example" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span>
  <span class="k">async </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Processing order</span><span class="dl">'</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">ack</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">nack</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// requeue on error</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="dl">'</span><span class="s1">order-service</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use multiple groups to implement <strong>fanout</strong>; use a single group for <strong>point-to-point</strong> load sharing.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_message_structure_brokermessage">3.3. Message Structure: <code>BrokerMessage</code></h3>
<div class="paragraph">
<p>The <code>BrokerMessage</code> interface defines the shape of every message flowing through OmniQueue.
It represents a single unit of data in transit between producer and consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">export</span> <span class="kr">interface</span> <span class="nx">BrokerMessage</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
   <span class="na">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
   <span class="nl">body</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
   <span class="nl">headers</span><span class="p">:</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>

   <span class="nf">ack</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="nf">nack</span><span class="p">(</span><span class="nx">requeue</span><span class="p">?:</span> <span class="nx">boolean</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<table id="table-broker-message-fields" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Message fields</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier for the message.
It should be globally unique to avoid collisions across brokers and environments.
Best practice: ULID or UUID v7 for sortable uniqueness.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>body</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON-serialisable payload of the message.
For binary data, encode as Base64 or use a broker-specific binary mode if supported.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>headers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metadata key/value pairs.
Common uses: content type, correlation IDs, trace context, tenant information.</p></td>
</tr>
</tbody>
</table>
<table id="table-broker-message-ack" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Message acknowledgement methods</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ack()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Positively acknowledges that the message was processed successfully.
In at-least-once systems, this will remove the message from the queue or commit the offset.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nack(requeue?: boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Negatively acknowledges the message.
If <code>requeue</code> is <code>true</code>, the broker will attempt redelivery (immediate or delayed, broker-dependent).
If <code>false</code>, the message may be routed to a Dead Letter Queue (DLQ) or discarded.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_best_practices">3.3.1. Best Practices</h4>
<div class="ulist">
<ul>
<li>
<p>Always call <code>ack()</code> <strong>exactly once</strong> for successfully processed messages.</p>
</li>
<li>
<p>Call <code>nack(true)</code> for transient errors (e.g., network failures to downstream systems).</p>
</li>
<li>
<p>Call <code>nack(false)</code> for permanent errors (e.g., invalid schema) to avoid poison-message loops.</p>
</li>
<li>
<p>Store <code>id</code> and relevant <code>headers</code> for idempotent processing in at-least-once systems.</p>
</li>
</ul>
</div>
<div id="code-broker-message-handler" class="listingblock">
<div class="title">Example: Handling <code>BrokerMessage</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">payments</span><span class="dl">'</span><span class="p">,</span>
  <span class="k">async </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nf">isValidPayment</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">body</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid payment</span><span class="dl">'</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">nack</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span> <span class="c1">// send to DLQ</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">await</span> <span class="nf">processPayment</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">ack</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Temporary error, retrying</span><span class="dl">'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">nack</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// requeue for retry</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="dl">'</span><span class="s1">payment-processor</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_groups_and_work_sharing_semantics">3.4. Groups and Work-sharing Semantics</h3>
<div class="paragraph">
<p>In OmniQueue, <strong>every subscription belongs to a group</strong> — this is not optional.
The <code>groupId</code> parameter in <code>subscribe()</code> is the explicit contract that defines how messages are delivered and balanced among consumers.</p>
</div>
<div class="sect3">
<h4 id="_why_groupid_is_mandatory">3.4.1. Why <code>groupId</code> is mandatory</h4>
<div class="ulist">
<ul>
<li>
<p>Prevents <strong>accidental global broadcast</strong> to all consumers.</p>
</li>
<li>
<p>Makes <strong>intent explicit</strong> in code: you either want fanout (multiple groups) or point-to-point (single group).</p>
</li>
<li>
<p>Aligns OmniQueue’s semantics with modern brokers like Kafka, NATS JetStream, and Pulsar, where groups (or their equivalents) are first-class.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_work_sharing_model">3.4.2. Work-sharing model</h4>
<div class="paragraph">
<p>When a producer publishes a message to a topic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each <strong>group</strong> subscribed to that topic receives a full copy of the message stream.</p>
</li>
<li>
<p>Within each group, <strong>only one consumer</strong> handles a given message.</p>
</li>
<li>
<p>The broker decides which consumer in the group gets the next message, based on its load-balancing strategy.</p>
</li>
</ul>
</div>
<hr>
<div id="ch3-consumer-group-work-sharing" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch3-consumer-group-work-sharing-bd21caee01cde99fb5bf3276ef279a82cc97604b3fcad3545b7340871eeb2260.png" alt="Consumer group work-sharing">
</div>
<div class="title">Figure 9. Consumer group work-sharing</div>
</div>
</div>
<div class="sect3">
<h4 id="_patterns_enabled_by_groupid">3.4.3. Patterns enabled by <code>groupId</code></h4>
<div class="ulist">
<ul>
<li>
<p><strong>Point-to-point load sharing</strong>:
Use a single group for all consumers that should share the workload.</p>
</li>
<li>
<p><strong>Fanout processing</strong>:
Use multiple groups, each representing an independent processing path.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handleOrder</span><span class="p">,</span> <span class="dl">'</span><span class="s1">order-service</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handleFraud</span><span class="p">,</span> <span class="dl">'</span><span class="s1">fraud-check</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handleAnalytics</span><span class="p">,</span> <span class="dl">'</span><span class="s1">analytics</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operational_considerations">3.4.4. Operational considerations</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Scaling throughput</strong>: Add more consumers to the same group to process messages faster.</p>
</li>
<li>
<p><strong>Zero-downtime deployment</strong>: Temporarily run old and new versions of a consumer in the same group to drain messages during rollout.</p>
</li>
<li>
<p><strong>Isolated experiments</strong>: Spin up a separate group for A/B testing without impacting production consumers.</p>
</li>
<li>
<p><strong>Back-pressure management</strong>: Monitor group-level consumer lag to detect bottlenecks.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In some brokers, group identifiers are durable — the broker remembers offsets per group even if no consumers are active. This allows resuming consumption from the last processed message.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lifecycle_management_init_close">3.5. Lifecycle Management (<code>init</code>, <code>close</code>)</h3>
<div class="paragraph">
<p>OmniQueue brokers follow a <strong>well-defined lifecycle</strong> to ensure connections are properly established, resources are managed, and workloads are gracefully shut down.</p>
</div>
<div class="sect3">
<h4 id="_initialization_init">3.5.1. Initialization (<code>init()</code>)</h4>
<div class="paragraph">
<p>Before you can send or receive messages, you <strong>must</strong> initialize the broker instance.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establishes network connections to the broker or peer nodes.</p>
</li>
<li>
<p>Performs authentication/authorization (if required).</p>
</li>
<li>
<p>Prepares client internals such as connection pools, channel/session objects, and background heartbeat tasks.</p>
</li>
<li>
<p>May lazily create broker-side resources (queues, topics, streams) depending on the adapter.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">import</span> <span class="p">{</span> <span class="nx">create</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">omni-queue-core</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Create broker instance from provider</span>
<span class="kd">const</span> <span class="nx">broker</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">create</span><span class="p">(</span><span class="dl">'</span><span class="s1">rabbitmq</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">host</span><span class="p">:</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">port</span><span class="p">:</span> <span class="mi">5672</span><span class="p">,</span>
  <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// Must be called before publish/subscribe</span>
<span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">init</span><span class="p">();</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In production, call <code>init()</code> <strong>during service startup</strong> and ensure it completes before accepting external requests. Failing to initialize may cause publish or subscribe calls to throw errors.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_graceful_shutdown_close">3.5.2. Graceful shutdown (<code>close()</code>)</h4>
<div class="paragraph">
<p>When your service is terminating, <strong>always close the broker connection</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensures in-flight messages are acknowledged before disconnection.</p>
</li>
<li>
<p>Releases network sockets, file handles, and background workers.</p>
</li>
<li>
<p>Helps the broker redistribute work quickly to other consumers in the same group.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="nx">process</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">SIGTERM</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Shutting down…</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span>
  <span class="nx">process</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Pair <code>init()</code> and <code>close()</code> in a lifecycle manager, such as:
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Node.js process hooks (<code>SIGTERM</code>, <code>SIGINT</code>).</p>
</li>
<li>
<p>HTTP server start/stop callbacks.</p>
</li>
<li>
<p>Framework lifecycle hooks (NestJS <code>OnModuleInit</code> / <code>OnModuleDestroy</code>).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_common_pitfalls">3.5.3. Common pitfalls</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Skipping <code>close()</code></strong>: Can lead to stale connections or message redelivery delays.</p>
</li>
<li>
<p><strong>Closing too early</strong>: If you close before acknowledging all messages, some brokers will redeliver them.</p>
</li>
<li>
<p><strong>Multiple <code>init()</code> calls</strong>: Avoid re-initializing the same broker instance; instead, reuse the connection.</p>
</li>
</ul>
</div>
<div id="ch3-lifecycle-overview" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch3-lifecycle-overview-e513eea4c7883070eb5d1ab78026fd4fcba22f6555d64a6507e0859feb93faf1.png" alt="Lifecycle overview">
</div>
<div class="title">Figure 10. Lifecycle overview</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_error_handling_ack_nack">3.6. Error Handling (<code>ack</code>, <code>nack</code>)</h3>
<div class="paragraph">
<p>OmniQueue enforces explicit acknowledgement semantics for all consumed messages.
This makes error handling <strong>predictable</strong> and <strong>adapter-agnostic</strong>, regardless of broker type.</p>
</div>
<div class="sect3">
<h4 id="_acknowledgement_ack">3.6.1. Acknowledgement (<code>ack()</code>)</h4>
<div class="paragraph">
<p>Calling <code>ack()</code> tells the broker:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The message has been processed successfully.</p>
</li>
<li>
<p>It can be removed from the queue or marked as complete in the log.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">await</span> <span class="nx">broker</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">orders</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nf">processOrder</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">ack</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Processing failed</span><span class="dl">'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">nack</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// retry</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="dl">'</span><span class="s1">order-service</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">ensure</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Always <code>ack()</code> <strong>after</strong> completing the business logic, not before.
Acknowledging too early risks losing messages if the process crashes mid-task.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_negative_acknowledgement_nackrequeue_boolean">3.6.2. Negative acknowledgement (<code>nack(requeue?: boolean)</code>)</h4>
<div class="paragraph">
<p>Calling <code>nack()</code> signals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The message <strong>could not</strong> be processed.</p>
</li>
<li>
<p>The broker may requeue the message for retry (if <code>requeue</code> is <code>true</code>) or discard/send to DLQ (if <code>false</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Usage patterns:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nack(true)</code> → retry later (transient failure).</p>
</li>
<li>
<p><code>nack(false)</code> → drop or route to DLQ (poison message).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_idempotency_for_at_least_once_delivery">3.6.3. Idempotency for at-least-once delivery</h4>
<div class="paragraph">
<p>Since most brokers operate with <strong>at-least-once</strong> guarantees, your consumer logic must be <strong>idempotent</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure repeating the same message does not cause incorrect results.</p>
</li>
<li>
<p>Common strategies:</p>
</li>
<li>
<p>Use a <strong>message ID store</strong> (database, Redis) to track processed IDs.</p>
</li>
<li>
<p>Apply <strong>upserts</strong> instead of inserts.</p>
</li>
<li>
<p>Wrap business logic in transactional boundaries.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_retry_dlq_patterns">3.6.4. Retry &amp; DLQ patterns</h4>
<div class="paragraph">
<p><strong>Retry loop:</strong>
Many brokers allow message redelivery after a delay, often via dead-lettering with a TTL and re-queue policy.</p>
</div>
<div class="paragraph">
<p><strong>DLQ (Dead Letter Queue):</strong>
Capture messages that consistently fail to process.
This enables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debugging message payloads.</p>
</li>
<li>
<p>Backfilling after code fixes.</p>
</li>
<li>
<p>Alerting when thresholds are reached.</p>
</li>
</ul>
</div>
<div id="ch3-ack-nack-lifecycle" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch3-ack-nack-lifecycle-5fabd8852cabec2173ea56cddb5ca619a0487942972990afcc5dedcbb11b4faa.png" alt="ack/nack lifecycle">
</div>
<div class="title">Figure 11. ack/nack lifecycle</div>
</div>
</div>
<div class="sect3">
<h4 id="_omniqueue_adapter_mapping">3.6.5. OmniQueue adapter mapping</h4>
<div class="paragraph">
<p>Different brokers use different APIs, but OmniQueue normalizes them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RabbitMQ</strong> → <code>channel.ack()</code> / <code>channel.nack()</code></p>
</li>
<li>
<p><strong>Kafka</strong> → commit offset / seek &amp; reprocess</p>
</li>
<li>
<p><strong>NATS JetStream</strong> → <code>msg.ack()</code> / <code>msg.nak({ delay })</code></p>
</li>
<li>
<p><strong>ZeroMQ</strong> → application-level ack handling</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You <strong>always</strong> use <code>msg.ack()</code> and <code>msg.nack()</code> in OmniQueue, regardless of broker.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When integrating with multiple brokers, always assume <strong>at-least-once</strong> and make consumers idempotent.
This ensures consistent behavior even if you switch adapters.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_omniqueue_core_flow_diagram">3.7. OmniQueue Core Flow Diagram</h3>
<div class="paragraph">
<p>The OmniQueue core flow represents the <strong>end-to-end lifecycle</strong> of a message — from creation to final acknowledgement — in a <strong>broker-agnostic</strong> manner.
This view is essential for both developers and operators to understand how OmniQueue mediates between application code and underlying messaging infrastructure.</p>
</div>
<div id="ch3-core-flow-overview" class="imageblock kroki">
<div class="content">
<img src="/home/runner/work/omniqueue-book/omniqueue-book/docs/en/images/ch3-core-flow-overview-b23c6d70b15c3aff6fcd45cd83d6ca9dfc434125e1b86cb01e9b533c48bd6539.png" alt="Core Flow Overview">
</div>
<div class="title">Figure 12. Core Flow Overview</div>
</div>
<div class="sect3">
<h4 id="_how_to_read_this_diagram">3.7.1. How to Read This Diagram</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Application Layer</strong> — Your service’s producer and consumer code.</p>
</li>
<li>
<p><strong>OmniQueue Core</strong> — The broker-agnostic interface (<code>publish</code>, <code>subscribe</code>) and internal adapter interface.</p>
</li>
<li>
<p><strong>Broker Adapter</strong> — Provider-specific implementation (RabbitMQ, Kafka, NATS, etc.).</p>
</li>
<li>
<p><strong>Broker</strong> — The actual messaging infrastructure.</p>
</li>
<li>
<p><strong>Destination</strong> — The queue, topic, or stream created or ensured.</p>
</li>
<li>
<p><strong>Consumer Group Assignment</strong> — The broker’s work-sharing or partition assignment process.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_flow_breakdown">3.7.2. Flow Breakdown</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Producer Code</strong></p>
<div class="ulist">
<ul>
<li>
<p>Calls <code>publish()</code> (topic-based API) or <code>send()</code> (if adapter supports queue semantics) with a <code>BrokerMessage</code> payload.</p>
</li>
<li>
<p>Can set <code>ensure</code> and <code>createOptions</code> for destination management.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>OmniQueue API</strong></p>
<div class="ulist">
<ul>
<li>
<p>Validates parameters.</p>
</li>
<li>
<p>Wraps the payload in OmniQueue’s standard format.</p>
</li>
<li>
<p>Passes request to the registered adapter via the adapter interface.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Broker Adapter</strong></p>
<div class="ulist">
<ul>
<li>
<p>Maps OmniQueue’s API calls to the broker’s native client library calls.</p>
</li>
<li>
<p>Ensures destination exists if <code>ensure</code> is <code>true</code>.</p>
</li>
<li>
<p>Serialises the message body and headers into broker-specific format.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Destination Creation/Lookup</strong></p>
<div class="ulist">
<ul>
<li>
<p>Broker creates or verifies the target queue/topic/stream.</p>
</li>
<li>
<p>Applies <code>createOptions</code> (e.g., partitions, durability, replication).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Delivery to Consumer Group</strong></p>
<div class="ulist">
<ul>
<li>
<p>Broker assigns messages to a consumer in the target group.</p>
</li>
<li>
<p>In <strong>point-to-point</strong>, exactly one consumer in the group processes each message.</p>
</li>
<li>
<p>In <strong>fanout</strong>, all groups subscribed receive the message.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Handler Execution</strong></p>
<div class="ulist">
<ul>
<li>
<p>Message arrives at the subscriber’s handler.</p>
</li>
<li>
<p>Handler processes and calls <code>ack()</code> (success) or <code>nack()</code> (failure).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Ack/Nack Propagation</strong></p>
<div class="ulist">
<ul>
<li>
<p><code>ack()</code> removes or commits the message in the broker.</p>
</li>
<li>
<p><code>nack()</code> either discards or requeues the message (depending on <code>requeue</code>).</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_operational_notes">3.7.3. Operational Notes</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Backpressure Management</strong> — Most adapters expose prefetch or flow control to prevent overwhelming consumers.</p>
</li>
<li>
<p><strong>Tracing</strong> — Add correlation IDs in <code>headers</code> for distributed tracing.</p>
</li>
<li>
<p><strong>Error Containment</strong> — Use dead-letter queues to capture repeatedly failed messages.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Understanding this flow helps in debugging end-to-end issues, such as “messages not being delivered” or “duplicates appearing” — often the cause lies at a specific hand-off in this chain.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-08-08 09:57:45 UTC
</div>
</div>
</body>
</html>